
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Mia Area - AUROOMS</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .dashboard-card {
      background: var(--card-background-color);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .booking-card {
      border: 1px solid var(--border-color);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }
    .booking-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #007bff;
    }
    .booking-status {
      display: inline-block;
      padding: 0.2rem 0.8rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .status-confirmed { background: #d4edda; color: #155724; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    .profile-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .payment-methods-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .payment-method-card {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .payment-method-card:hover {
      border-color: #007bff;
      background: #f8f9ff;
    }
    .payment-method-card.active {
      border-color: #007bff;
      background: #e7f3ff;
    }
    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-item {
      text-align: center;
      padding: 1rem;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border-radius: 8px;
    }
    .stat-number {
      font-size: 1.8rem;
      font-weight: bold;
    }
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .loyalty-progress {
      background: var(--border-color);
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
      margin: 1rem 0;
    }
    .loyalty-progress-bar {
      background: linear-gradient(90deg, #28a745, #20c997);
      height: 100%;
      transition: width 0.3s ease;
    }
    .documents-list {
      list-style: none;
      padding: 0;
    }
    .document-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    .document-item:hover {
      background: #f8f9fa;
    }
    @media (max-width: 768px) {
      .profile-section { grid-template-columns: 1fr; }
      .payment-methods-grid { grid-template-columns: 1fr; }
      .stats-overview { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
    <nav class="container-fluid">
    <ul>
      <li>
        <a href="index.html" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
          <img src="./attached_assets/logo_aurooms.jpg" alt="AUROOMS Logo" style="height: 40px; width: auto; border-radius: 4px;">
          <strong>AUROOMS</strong>
        </a>
      </li>
    </ul>
    <ul>
      <li id="auth-links">
        <!-- Will be populated by JavaScript -->
      </li>
      <li class="lang-toggle">
        <img src="https://flagcdn.com/w40/it.png" class="flag" onclick="switchLang('it')" alt="IT">
        <img src="https://flagcdn.com/w40/gb.png" class="flag" onclick="switchLang('en')" alt="EN">
      </li>
    </ul>
  </nav>

  <main class="container">
    <hgroup style="margin-bottom: 2rem;">
      <h1 data-lang="it">La Mia Area AUROOMS</h1>
      <h1 class="hidden" data-lang="en">My AUROOMS Area</h1>
      <h3 data-lang="it">Benvenuto, <span id="user-name">—</span></h3>
      <h3 class="hidden" data-lang="en">Welcome, <span id="user-name-en">—</span></h3>
    </hgroup>

    <!-- Statistiche Personali -->
    <div class="stats-overview">
      <div class="stat-item">
        <div class="stat-number" id="total-bookings">0</div>
        <div class="stat-label" data-lang="it">Prenotazioni Totali</div>
        <div class="stat-label hidden" data-lang="en">Total Bookings</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="total-nights">0</div>
        <div class="stat-label" data-lang="it">Notti Totali</div>
        <div class="stat-label hidden" data-lang="en">Total Nights</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="total-spent">€0</div>
        <div class="stat-label" data-lang="it">Spesa Totale</div>
        <div class="stat-label hidden" data-lang="en">Total Spent</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="loyalty-points">0</div>
        <div class="stat-label" data-lang="it">Punti Fedeltà</div>
        <div class="stat-label hidden" data-lang="en">Loyalty Points</div>
      </div>
    </div>

    <div class="grid">
      <div>
        <!-- My Bookings -->
        <div class="dashboard-card">
          <h3 data-lang="it">Le Mie Prenotazioni</h3>
          <h3 class="hidden" data-lang="en">My Bookings</h3>
          <div id="bookings-list"><!-- Popolato dinamicamente --></div>
          <div style="text-align: center; margin-top: 1.5rem;">
            <a href="index.html#booking" role="button" data-lang="it">Nuova Prenotazione</a>
            <a href="index.html#booking" role="button" class="hidden" data-lang="en">New Booking</a>
          </div>
        </div>

        <!-- Metodi di Pagamento -->
        <div class="dashboard-card">
          <h3 data-lang="it">💳 Metodi di Pagamento</h3>
          <h3 class="hidden" data-lang="en">💳 Payment Methods</h3>
          <p data-lang="it">Gestisci i tuoi metodi di pagamento salvati</p>
          <p class="hidden" data-lang="en">Manage your saved payment methods</p>
          
          <div id="payment-methods-container" class="payment-methods-grid"><!-- Popolato dinamicamente --></div>
          <div style="margin-top: 1rem; text-align:center;">
            <button type="button" class="secondary" onclick="toggleAddPaymentForm(true)">➕ <span data-lang="it">Aggiungi Metodo</span><span class="hidden" data-lang="en">Add Method</span></button>
          </div>
          <form id="add-payment-form" class="booking-card" style="display:none; margin-top:1rem;">
            <div class="grid">
              <div>
                <label data-lang="it">Tipo</label><label class="hidden" data-lang="en">Type</label>
                <select id="pm-type">
                  <option value="card">Carta</option>
                  <option value="paypal">PayPal</option>
                </select>
              </div>
              <div>
                <label data-lang="it">Etichetta</label><label class="hidden" data-lang="en">Label</label>
                <input id="pm-label" type="text" placeholder="Es. Visa personale" />
              </div>
            </div>
            <div id="pm-card-fields" class="grid">
              <div>
                <label>Numero Carta</label>
                <input id="pm-card-number" type="text" maxlength="19" placeholder="1234 5678 9012 3456" />
              </div>
              <div>
                <label>Scadenza (MM/YY)</label>
                <input id="pm-card-exp" type="text" maxlength="5" placeholder="12/26" />
              </div>
            </div>
            <div id="pm-paypal-fields" style="display:none;">
              <label>Email PayPal</label>
              <input id="pm-paypal-email" type="email" placeholder="nome@email.com" />
            </div>
            <div style="text-align:right; margin-top:0.5rem;">
              <button type="button" class="secondary" onclick="toggleAddPaymentForm(false)">Annulla</button>
              <button type="button" onclick="savePaymentMethod()">Salva</button>
            </div>
          </form>
        </div>

  <!-- (RIMOSSO) Documenti/Fatture -->

  <!-- (RIMOSSO) Azioni Rapide -->
      </div>

      <!-- Profile Section -->
      <div>
        <div class="dashboard-card">
          <h3 data-lang="it">👤 Il Mio Profilo</h3>
          <h3 class="hidden" data-lang="en">👤 My Profile</h3>
          <form id="profile-form">
            <div class="profile-section">
              <div>
                <label data-lang="it">Nome</label>
                <label class="hidden" data-lang="en">First Name</label>
                <input type="text" id="profile-nome" value="Mario" />
              </div>
              <div>
                <label data-lang="it">Cognome</label>
                <label class="hidden" data-lang="en">Last Name</label>
                <input type="text" id="profile-cognome" value="Rossi" />
              </div>
            </div>
            
            <label>Email</label>
            <input type="email" id="profile-email" value="mario.rossi@email.com" disabled />
            
            <label data-lang="it">Telefono</label>
            <label class="hidden" data-lang="en">Phone</label>
            <input type="tel" id="profile-telefono" value="+39 333 123 4567" />
            
            <label data-lang="it">Data di nascita</label>
            <label class="hidden" data-lang="en">Date of birth</label>
            <input type="date" id="profile-data-nascita" value="1985-05-15" />
            
            <label data-lang="it">Cittadinanza</label>
            <label class="hidden" data-lang="en">Nationality</label>
            <input type="text" id="profile-cittadinanza" value="Italiana" />
            
            <label data-lang="it">Documento di Identità</label>
            <label class="hidden" data-lang="en">Identity Document</label>
            <select id="profile-documento-tipo">
              <option value="carta-identita" data-lang="it">Carta d'Identità</option>
              <option value="patente" data-lang="it">Patente di Guida</option>
              <option value="passaporto" data-lang="it">Passaporto</option>
              <option value="carta-identita" class="hidden" data-lang="en">Identity Card</option>
              <option value="patente" class="hidden" data-lang="en">Driving License</option>
              <option value="passaporto" class="hidden" data-lang="en">Passport</option>
            </select>
            
            <label data-lang="it">Numero Documento</label>
            <label class="hidden" data-lang="en">Document Number</label>
            <input type="text" id="profile-documento-numero" placeholder="Es. AB1234567" />
            
            <label data-lang="it">Indirizzo di Fatturazione</label>
            <label class="hidden" data-lang="en">Billing Address</label>
            <input type="text" id="profile-indirizzo" placeholder="Via, Numero Civico" />
            
            <div class="profile-section">
              <div>
                <label data-lang="it">Città</label>
                <label class="hidden" data-lang="en">City</label>
                <input type="text" id="profile-citta" placeholder="Roma" />
              </div>
              <div>
                <label data-lang="it">CAP</label>
                <label class="hidden" data-lang="en">ZIP Code</label>
                <input type="text" id="profile-cap" placeholder="00100" />
              </div>
            </div>
            
            <label data-lang="it">Codice Fiscale</label>
            <label class="hidden" data-lang="en">Tax Code</label>
            <input type="text" id="profile-codice-fiscale" placeholder="RSSMRA85E15H501Z" />
            
            <button type="button" onclick="saveProfile()">
              💾 <span data-lang="it">Salva Modifiche</span><span class="hidden" data-lang="en">Save Changes</span>
            </button>
          </form>
          
          <!-- Change Password Button -->
          <div style="text-align: center; margin-top: 1rem;">
            <button type="button" class="secondary" onclick="showChangePassword()" id="change-password-btn">
              <span data-lang="it">🔑 Cambia Password</span>
              <span class="hidden" data-lang="en">🔑 Change Password</span>
            </button>
          </div>
        </div>

        <!-- Change Password Section -->
        <div class="dashboard-card" id="change-password-section" style="display: none;">
          <h3 data-lang="it">🔑 Cambia Password</h3>
          <h3 class="hidden" data-lang="en">🔑 Change Password</h3>
          <form id="change-password-form" onsubmit="handleChangePassword(event)">
            <div class="form-group">
              <label for="current-password" data-lang="it">Password Attuale</label>
              <label for="current-password" class="hidden" data-lang="en">Current Password</label>
              <input type="password" id="current-password" required placeholder="••••••••" />
            </div>

            <div class="form-group">
              <label for="new-password" data-lang="it">Nuova Password</label>
              <label for="new-password" class="hidden" data-lang="en">New Password</label>
              <input type="password" id="new-password" required minlength="6" placeholder="••••••••" />
            </div>

            <div class="form-group">
              <label for="confirm-new-password" data-lang="it">Conferma Nuova Password</label>
              <label for="confirm-new-password" class="hidden" data-lang="en">Confirm New Password</label>
              <input type="password" id="confirm-new-password" required minlength="6" placeholder="••••••••" />
            </div>

            <div id="password-error" class="error-message" style="display: none;"></div>
            <div id="password-success" class="success-message" style="display: none;"></div>

            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
              <button type="submit" class="primary">
                <span data-lang="it">🔒 Cambia Password</span>
                <span class="hidden" data-lang="en">🔒 Change Password</span>
              </button>
              <button type="button" class="secondary" onclick="hideChangePassword()">
                <span data-lang="it">Annulla</span>
                <span class="hidden" data-lang="en">Cancel</span>
              </button>
            </div>
          </form>
        </div>

  <!-- Sicurezza Account (2FA rimosso) -->
        <div class="dashboard-card">
          <h3 data-lang="it">🔐 Sicurezza Account</h3>
          <h3 class="hidden" data-lang="en">🔐 Account Security</h3>
          <div style="margin-bottom: 1rem;">
            <label data-lang="it">Password Attuale</label>
            <label class="hidden" data-lang="en">Current Password</label>
            <input type="password" id="current-password" placeholder="••••••••" />
          </div>
          <div style="margin-bottom: 1rem;">
            <label data-lang="it">Nuova Password</label>
            <label class="hidden" data-lang="en">New Password</label>
            <input type="password" id="new-password" placeholder="••••••••" />
          </div>
          <div style="margin-bottom: 1rem;">
            <label data-lang="it">Conferma Nuova Password</label>
            <label class="hidden" data-lang="en">Confirm New Password</label>
            <input type="password" id="confirm-password" placeholder="••••••••" />
          </div>
          <button type="button" onclick="changePassword()" class="secondary">
            🔑 <span data-lang="it">Cambia Password</span><span class="hidden" data-lang="en">Change Password</span>
          </button>
        </div>

  <!-- (RIMOSSO) Preferenze (email/SMS/privacy) -->

        <!-- Loyalty Program -->
        <div class="dashboard-card">
          <h3 data-lang="it">⭐ Programma Fedeltà AUROOMS</h3>
          <h3 class="hidden" data-lang="en">⭐ AUROOMS Loyalty Program</h3>
          <div style="text-align: center;">
            <div style="font-size: 2rem; color: #CD7F32; margin-bottom: 0.5rem;">🥉 BRONZE</div>
            <p data-lang="it"><strong>Livello attuale</strong></p>
            <p class="hidden" data-lang="en"><strong>Current Level</strong></p>
            
            <div class="loyalty-progress">
              <div class="loyalty-progress-bar" style="width: 60%"></div>
            </div>
            
            <p data-lang="it"><strong>3/5 soggiorni</strong> per raggiungere il livello Silver</p>
            <p class="hidden" data-lang="en"><strong>3/5 stays</strong> to reach Silver level</p>
            
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
              <h5 data-lang="it">Vantaggi Bronze:</h5>
              <h5 class="hidden" data-lang="en">Bronze Benefits:</h5>
              <ul style="text-align: left; margin: 0;">
                <li data-lang="it">✅ 5% di sconto su tutte le prenotazioni</li>
                <li data-lang="it">✅ Check-in prioritario</li>
                <li data-lang="it">✅ Wi-Fi premium gratuito</li>
                <li data-lang="it">✅ Late check-out gratuito (fino alle 13:00)</li>
                <li class="hidden" data-lang="en">✅ 5% discount on all bookings</li>
                <li class="hidden" data-lang="en">✅ Priority check-in</li>
                <li class="hidden" data-lang="en">✅ Free premium Wi-Fi</li>
                <li class="hidden" data-lang="en">✅ Free late check-out (until 1:00 PM)</li>
              </ul>
            </div>
            
            <div style="background: #e9ecef; padding: 1rem; border-radius: 8px;">
              <h5 data-lang="it">Prossimo livello - Silver:</h5>
              <h5 class="hidden" data-lang="en">Next level - Silver:</h5>
              <ul style="text-align: left; margin: 0;">
                <li data-lang="it">💎 10% di sconto</li>
                <li data-lang="it">💎 Upgrade camera (quando disponibile)</li>
                <li data-lang="it">💎 Colazione gratuita</li>
                <li data-lang="it">💎 Cancellazione flessibile</li>
                <li class="hidden" data-lang="en">💎 10% discount</li>
                <li class="hidden" data-lang="en">💎 Room upgrade (when available)</li>
                <li class="hidden" data-lang="en">💎 Free breakfast</li>
                <li class="hidden" data-lang="en">💎 Flexible cancellation</li>
              </ul>
            </div>
          </div>
        </div>

  <!-- (RIMOSSO) Centro Assistenza: i contatti sono nel footer -->
      </div>
    </div>
  </main>

  <footer class="container" style="margin-top:2rem; padding-top:1rem; border-top:1px solid var(--border-color);">
    <div style="display:flex; gap:1rem; justify-content:center; align-items:center; flex-wrap: wrap;">
      <a href="https://wa.me/393758843175" target="_blank" role="button" class="secondary" style="display:flex; align-items:center; gap:0.5rem;">
        <img src="./attached_assets/icons8-whatsapp-30.png" alt="WhatsApp" style="width:18px; height:18px;"> 
        <span>Contattaci su WhatsApp</span>
      </a>
      <a href="tel:+393758843175" role="button" class="secondary" style="display:flex; align-items:center; gap:0.5rem;">
        <img src="./attached_assets/icons8-whatsapp-30.png" alt="Telefono" style="width:18px; height:18px; filter: hue-rotate(200deg) brightness(0) invert(1);">
        <span>Telefono</span>
      </a>
      <a href="mailto:info@aurooms.it" role="button" class="secondary" style="display:flex; align-items:center; gap:0.5rem;">
        <span style="font-size:18px;">📧</span>
        <span>info@aurooms.it</span>
      </a>
    </div>
  </footer>

  <script src="script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in (in production, verify with backend)
      const currentUser = localStorage.getItem('aurooms_current_user');
      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }
      
      // Load user data
      const userData = JSON.parse(currentUser);
      document.getElementById('user-name').textContent = userData.firstName || userData.name || 'Utente';
      
  // Load user bookings & payment methods (in production, fetch from backend)
  renderBookings();
      renderPaymentMethods();
      loadUserStatistics();

      // Payment form type switch
      const pmType = document.getElementById('pm-type');
      if (pmType) {
        pmType.addEventListener('change', function() {
          const isCard = this.value === 'card';
          document.getElementById('pm-card-fields').style.display = isCard ? 'grid' : 'none';
          document.getElementById('pm-paypal-fields').style.display = isCard ? 'none' : 'block';
        });
      }
    });

    // ========== BOOKINGS UI ==========
  function getAllUserBookings() {
      const currentUser = JSON.parse(localStorage.getItem('aurooms_current_user'));
      const confirmed = JSON.parse(localStorage.getItem('aurooms_confirmed_bookings') || '[]');
      const pending = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
      const list = [];
      // Map confirmed
      confirmed.filter(b => b.customerEmail === currentUser.email).forEach(b => list.push({
        id: b.bookingReference || b.id || `CONF-${Date.now()}`,
        status: b.status || 'confirmed',
        roomName: b.roomName || (b.room && b.room.name) || '—',
        checkin: b.checkin || (b.dates && b.dates.checkin),
        checkout: b.checkout || (b.dates && b.dates.checkout),
        guests: b.guests || (b.details && b.details.guests) || 1,
        nights: b.nights || (b.dates && b.dates.nights) || calcNights(b.checkin, b.checkout),
        total: b.totalPrice || b.total || 0,
        paymentMethod: b.paymentMethod || 'card',
        arrivalTime: b.arrivalTime || null
      }));
      // Map pending
      pending.filter(b => b.customerEmail === currentUser.email).forEach(b => list.push({
        id: b.bookingReference || `BOOK-${Date.now()}`,
        status: 'pending_payment',
        roomName: b.roomName,
        checkin: b.checkin,
        checkout: b.checkout,
        guests: b.guests,
        nights: b.nights || calcNights(b.checkin, b.checkout),
        total: b.totalPrice || 0,
        paymentMethod: 'transfer',
        arrivalTime: b.arrivalTime || null
      }));
      // Single completedBooking legacy (from conferma-finale)
      const legacy = JSON.parse(localStorage.getItem('completedBooking') || 'null');
      if (legacy && legacy.guest && legacy.guest.email === currentUser.email) {
        list.push({
          id: legacy.bookingReference || `CONF-${Date.now()}`,
          status: 'confirmed',
          roomName: legacy.room && legacy.room.name || legacy.roomName || '—',
          checkin: legacy.dates && legacy.dates.checkin,
          checkout: legacy.dates && legacy.dates.checkout,
          guests: legacy.details && legacy.details.guests || legacy.guests || 1,
          nights: legacy.dates && legacy.dates.nights || calcNights(legacy.dates.checkin, legacy.dates.checkout),
          total: legacy.total || legacy.totalPrice || 0,
          paymentMethod: 'card',
          arrivalTime: null
        });
      }
  // Mostra prenotazioni confermate e in attesa (no azione di pagamento)
  const visible = list.filter(b => b.status === 'confirmed' || b.status === 'pending_payment');
  // Sort by checkin desc
  return visible.sort((a,b) => new Date(b.checkin) - new Date(a.checkin));
    }

    function calcNights(ci, co) {
      if (!ci || !co) return 1;
      const d1 = new Date(ci); const d2 = new Date(co);
      return Math.max(1, Math.ceil((d2 - d1) / 86400000));
    }

    function withinCancellationWindow(checkin) {
      const checkinDate = new Date(checkin);
      const now = new Date();
      const diffDays = Math.ceil((checkinDate - now) / 86400000);
      return diffDays >= 7;
    }

    function renderBookings() {
      const container = document.getElementById('bookings-list');
      if (!container) return;
      const bookings = getAllUserBookings();
      container.innerHTML = '';

      if (bookings.length === 0) {
        const empty = document.createElement('div');
        empty.style.textAlign = 'center';
        empty.style.padding = '1rem';
        empty.innerHTML = '<p>Nessuna prenotazione trovata.</p>';
        container.appendChild(empty);
        return;
      }

      bookings.forEach(b => {
        const card = document.createElement('div');
        card.className = 'booking-card';
        const statusClass = b.status === 'confirmed' ? 'status-confirmed' : (b.status === 'pending_payment' ? 'status-pending' : 'status-cancelled');
        const nightsText = `${b.nights} ${b.nights > 1 ? 'notti' : 'notte'}`;
        const ci = new Date(b.checkin).toLocaleDateString('it-IT');
        const co = new Date(b.checkout).toLocaleDateString('it-IT');
        const cancellable = b.status !== 'cancelled' && withinCancellationWindow(b.checkin);
        const whatsappHref = `https://wa.me/393758843175?text=${encodeURIComponent('Ciao, ho bisogno di assistenza per la prenotazione ' + b.id)}`;
        const arrival = b.arrivalTime || '';

        card.innerHTML = `
          <div class="grid">
            <div>
              <h5>${b.roomName}</h5>
              <p>📅 ${ci} - ${co} (${nightsText})</p>
              <p>👥 ${b.guests} ospiti</p>
              <p>🔢 <strong>Numero prenotazione:</strong> ${b.id}</p>
              <div class="grid" style="margin-top:0.5rem; grid-template-columns: 1fr 1fr; gap:0.5rem;">
                <div>
                  <label>Orario di arrivo</label>
                  <input type="time" value="${arrival}" min="15:00" max="22:00" data-booking-id="${b.id}" onchange="updateArrivalTime(event)">
                  <small>Consentito: 15:00 - 22:00</small>
                </div>
              </div>
            </div>
            <div style="text-align: right;">
              <span class="booking-status ${statusClass}">${b.status === 'confirmed' ? 'Confermata' : (b.status === 'pending_payment' ? 'In attesa' : 'Annullata')}</span>
              <p style="margin-top: 0.5rem;"><strong>€${b.total}</strong></p>
              <small>
                ${cancellable ? `<a href="#" onclick="cancelBookingStrict('${b.id}')">Cancella</a>` : `<a href="${whatsappHref}" target="_blank">Contattaci</a>`}
              </small>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function updateArrivalTime(e) {
      const id = e.target.getAttribute('data-booking-id');
      const value = e.target.value;
      // Update in all storages where present
      ['aurooms_confirmed_bookings','aurooms_pending_bookings'].forEach(key => {
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        let changed = false;
        arr.forEach(b => {
          const bid = b.bookingReference || b.id;
          if (bid === id) { b.arrivalTime = value; changed = true; }
        });
        if (changed) localStorage.setItem(key, JSON.stringify(arr));
      });
      alert('⏰ Orario di arrivo aggiornato');
    }

    function cancelBookingStrict(bookingId) {
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      // Check window again for safety
      // Find booking checkin
      const all = getAllUserBookings();
      const bk = all.find(x => x.id === bookingId);
      if (!bk) return;
      if (!withinCancellationWindow(bk.checkin)) {
        const whatsappHref = `https://wa.me/393758843175?text=${encodeURIComponent((isEnglish?'Hello, I need help with booking ':'Ciao, ho bisogno di assistenza per la prenotazione ')+ bookingId)}`;
        window.open(whatsappHref, '_blank');
        return;
      }
      if (confirm(isEnglish ? 'Are you sure you want to cancel this booking?' : 'Sei sicuro di voler cancellare questa prenotazione?')) {
        // Mark as cancelled in confirmed or pending arrays
        ['aurooms_confirmed_bookings','aurooms_pending_bookings'].forEach(key => {
          const arr = JSON.parse(localStorage.getItem(key) || '[]');
          let changed = false;
          arr.forEach(b => {
            const bid = b.bookingReference || b.id;
            if (bid === bookingId) { b.status = 'cancelled'; changed = true; }
          });
          if (changed) localStorage.setItem(key, JSON.stringify(arr));
        });
        renderBookings();
        alert(isEnglish ? 'Booking cancelled' : 'Prenotazione cancellata');
      }
    }

    function viewBookingDetails(bookingId) {
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      alert(isEnglish ? 
        `Viewing booking details ${bookingId}` : 
        `Visualizzazione dettagli prenotazione ${bookingId}`);
      // In production, open modal or redirect to details page
    }

    function cancelBooking(bookingId) {
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      if (confirm(isEnglish ? 
        'Are you sure you want to cancel this booking?' : 
        'Sei sicuro di voler cancellare questa prenotazione?')) {
        alert(isEnglish ? 
          `Booking ${bookingId} cancelled. We will contact you to confirm the refund.` : 
          `Prenotazione ${bookingId} cancellata. Ti contatteremo per confermare il rimborso.`);
        // In production, send cancellation request to backend
      }
    }

    function payBooking(bookingId) {
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      alert(isEnglish ? 
        `Redirecting to payment for ${bookingId}` : 
        `Reindirizzamento al pagamento per ${bookingId}`);
      // In production, redirect to payment page
    }

    function saveProfile() {
      // Aggiorna profilo senza consentire modifica della email
      const currentUser = JSON.parse(localStorage.getItem('aurooms_current_user'));
      const updated = {
        ...currentUser,
        firstName: document.getElementById('profile-nome').value,
        lastName: document.getElementById('profile-cognome').value,
        name: `${document.getElementById('profile-nome').value} ${document.getElementById('profile-cognome').value}`.trim(),
        phone: document.getElementById('profile-telefono').value,
        dateOfBirth: document.getElementById('profile-data-nascita').value,
        nationality: document.getElementById('profile-cittadinanza').value,
        // email rimane invariata
        email: currentUser.email
      };
      localStorage.setItem('aurooms_current_user', JSON.stringify(updated));
      localStorage.setItem('userData', JSON.stringify(updated));
      if (typeof updateAuthUI === 'function') try { updateAuthUI(); } catch(e) {}
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      alert(isEnglish ? 'Profile updated successfully!' : 'Profilo aggiornato con successo!');
    }

    function savePreferences() {
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      alert(isEnglish ? 'Preferences saved!' : 'Preferenze salvate!');
    }

    function downloadInvoices() {
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      alert(isEnglish ? 'Download invoices in development' : 'Download fatture in sviluppo');
    }

    function requestSupport() {
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      const message = isEnglish ? 
        "Hello! I need assistance with my AUROOMS account." : 
        "Ciao! Ho bisogno di assistenza per il mio account AUROOMS.";
      window.open(`https://wa.me/393758843175?text=${encodeURIComponent(message)}`, '_blank');
    }

    function logout() {
      localStorage.removeItem('aurooms_current_user');
      sessionStorage.clear();
      window.location.href = 'index.html';
    }

    // New enhanced functions for dashboard
    function loadUserStatistics() {
      // Calculate user statistics
      const confirmedBookings = JSON.parse(localStorage.getItem('aurooms_confirmed_bookings') || '[]');
      const currentUser = JSON.parse(localStorage.getItem('aurooms_current_user'));
      // Consider only confirmed
      const userBookings = confirmedBookings.filter(b => b.customerEmail === currentUser.email && (b.status === 'confirmed' || !b.status));
      const totalBookings = userBookings.length;
      const totalNights = userBookings.reduce((sum, booking) => sum + (booking.nights || 0), 0);
      const totalSpent = userBookings.reduce((sum, booking) => sum + (booking.totalPrice || 0), 0);
      const loyaltyPoints = totalBookings * 100 + totalNights * 10;
      document.getElementById('total-bookings').textContent = totalBookings;
      document.getElementById('total-nights').textContent = totalNights;
      document.getElementById('total-spent').textContent = `€${totalSpent}`;
      document.getElementById('loyalty-points').textContent = loyaltyPoints;
    }

    function changePassword() {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      // Get current language for messages
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        alert(isEnglish ? '❌ Fill in all fields' : '❌ Compila tutti i campi');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        alert(isEnglish ? '❌ New passwords do not match' : '❌ Le nuove password non coincidono');
        return;
      }
      
      if (newPassword.length < 6) {
        alert(isEnglish ? '❌ New password must be at least 6 characters' : '❌ La nuova password deve essere di almeno 6 caratteri');
        return;
      }
      
      // Update password
      const currentUser = JSON.parse(localStorage.getItem('aurooms_current_user'));
      currentUser.password = newPassword;
      localStorage.setItem('aurooms_current_user', JSON.stringify(currentUser));
      
      // Clear password fields
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';
      
      alert(isEnglish ? '✅ Password changed successfully!' : '✅ Password cambiata con successo!');
    }

    function setup2FA() {
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      alert(isEnglish ? 
        '🔐 2FA setup in development\n\nWill be available in future versions.' : 
        '🔐 Configurazione 2FA in sviluppo\n\nSarà disponibile nelle prossime versioni.');
    }

    // ========== PAYMENT METHODS ==========
    function getPaymentMethods() {
      const currentUser = JSON.parse(localStorage.getItem('aurooms_current_user'));
      const key = `au_pm_${currentUser.email}`;
      return JSON.parse(localStorage.getItem(key) || '[]');
    }
    function setPaymentMethods(list) {
      const currentUser = JSON.parse(localStorage.getItem('aurooms_current_user'));
      const key = `au_pm_${currentUser.email}`;
      localStorage.setItem(key, JSON.stringify(list));
    }
    function renderPaymentMethods() {
      const container = document.getElementById('payment-methods-container');
      if (!container) return;
      const items = getPaymentMethods();
      container.innerHTML = '';
      if (!items.length) {
        const empty = document.createElement('div');
        empty.className = 'payment-method-card';
        empty.innerHTML = '<div style="font-size:2rem;">💳</div><p>Nessun metodo salvato</p>';
        container.appendChild(empty);
        return;
      }
      items.forEach((pm, idx) => {
        const card = document.createElement('div');
        card.className = 'payment-method-card' + (pm.default ? ' active' : '');
        card.innerHTML = `
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">${pm.type === 'paypal' ? '🅿️' : '💳'}</div>
          <h5>${pm.label || (pm.type === 'paypal' ? 'PayPal' : 'Carta')}</h5>
          <p>${pm.type === 'paypal' ? (pm.email || '') : (pm.mask || '•••• •••• ••••')}</p>
          <div style="display:flex; gap:.5rem; justify-content:center; margin-top:.5rem;">
            <button class="secondary" onclick="setDefaultPM(${idx})">${pm.default ? 'Predefinito' : 'Imposta predefinito'}</button>
            <button class="secondary" onclick="removePM(${idx})">Rimuovi</button>
          </div>
        `;
        container.appendChild(card);
      });
    }
    function toggleAddPaymentForm(show) {
      document.getElementById('add-payment-form').style.display = show ? 'block' : 'none';
    }
    function savePaymentMethod() {
      const type = document.getElementById('pm-type').value;
      const label = (document.getElementById('pm-label').value || '').trim();
      const list = getPaymentMethods();
      if (type === 'card') {
        let num = (document.getElementById('pm-card-number').value || '').replace(/\s/g,'');
        const exp = (document.getElementById('pm-card-exp').value || '').trim();
        if (num.length < 13 || !/^[0-9]{13,19}$/.test(num)) { alert('Numero carta non valido'); return; }
        if (!/^\d{2}\/\d{2}$/.test(exp)) { alert('Scadenza non valida'); return; }
        const mask = `•••• •••• •••• ${num.slice(-4)}`;
        list.push({ type:'card', label: label || 'Carta', mask, exp, default: list.length === 0 });
      } else {
        const email = (document.getElementById('pm-paypal-email').value || '').trim();
        if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { alert('Email PayPal non valida'); return; }
        list.push({ type:'paypal', label: label || 'PayPal', email, default: list.length === 0 });
      }
      setPaymentMethods(list);
      toggleAddPaymentForm(false);
      // reset form
      document.getElementById('pm-label').value = '';
      document.getElementById('pm-card-number').value = '';
      document.getElementById('pm-card-exp').value = '';
      document.getElementById('pm-paypal-email').value = '';
      renderPaymentMethods();
      alert('Metodo di pagamento salvato');
    }
    function setDefaultPM(index) {
      const list = getPaymentMethods();
      list.forEach((p,i)=> p.default = i === index);
      setPaymentMethods(list);
      renderPaymentMethods();
    }
    function removePM(index) {
      const list = getPaymentMethods();
      list.splice(index,1);
      if (list.length && !list.some(p=>p.default)) list[0].default = true;
      setPaymentMethods(list);
      renderPaymentMethods();
    }

    function downloadConfirmation(bookingId) {
      const isEnglish = !document.querySelector('[data-lang="en"]').classList.contains('hidden');
      alert(isEnglish ? 
        `Download confirmation for booking ${bookingId}` : 
        `Download conferma per prenotazione ${bookingId}`);
    }

  // (RIMOSSO) gestione fatture
  </script>
</body>
</html>
