<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pagamento - AUROOMS Guest House</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <link rel="stylesheet" href="style.css" />
  <!-- EmailJS per invio email reali -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    .payment-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
    }
    
    .booking-summary {
      background: #2d3748;
      border: 1px solid #4a5568;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      color: #ffffff;
    }
    
    .payment-methods {
      display: grid;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .payment-method {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .payment-method:hover {
      border-color: #007bff;
      background-color: #f8f9ff;
    }
    
    .payment-method.selected {
      border-color: #007bff;
      background-color: #e7f3ff;
    }
    
    .payment-method input[type="radio"] {
      margin: 0;
    }
    
    .payment-icon {
      font-size: 2rem;
      width: 60px;
      text-align: center;
    }
    
    .payment-details {
      flex: 1;
    }
    
    .payment-form {
      display: none;
      background: #2d3748;
      border: 1px solid #4a5568;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 1rem;
      color: #ffffff;
    }
    
    .payment-form.active {
      display: block;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .total-section {
      background: #007bff;
      color: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .secure-payment {
      text-align: center;
      color: #6c757d;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    
    .success-animation {
      display: none;
      text-align: center;
      padding: 3rem;
    }
    
    .success-animation.show {
      display: block;
    }
    
    .checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #28a745;
      position: relative;
      margin: 0 auto 2rem;
    }
    
    .checkmark::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 3rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <nav class="container-fluid">
    <ul>
      <li>
        <a href="index.html" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
          <img src="./attached_assets/logo_aurooms.jpg" alt="AUROOMS Logo" style="height: 35px; width: auto; border-radius: 4px;">
          <strong>AUROOMS</strong>
        </a>
      </li>
    </ul>
    <ul>
      <li><a href="index.html#rooms" data-lang="it">Camere</a></li>
      <li><a href="index.html#rooms" class="hidden" data-lang="en">Rooms</a></li>
      <li><a href="index.html#booking" role="button" data-lang="it">Prenota</a></li>
      <li><a href="index.html#booking" role="button" class="hidden" data-lang="en">Book Now</a></li>
      <li class="lang-toggle">
        <img src="https://flagcdn.com/w40/it.png" class="flag" onclick="switchLang('it')" alt="IT">
        <img src="https://flagcdn.com/w40/gb.png" class="flag" onclick="switchLang('en')" alt="EN">
      </li>
    </ul>
  </nav>

  <main class="container">
    <div class="payment-container">
      
      <!-- Success Animation (Hidden by default) -->
      <div id="success-animation" class="success-animation">
        <div class="checkmark"></div>
        <h2 id="success-title" data-lang="it">Pagamento Completato!</h2>
        <h2 id="success-title-en" class="hidden" data-lang="en">Payment Completed!</h2>
        <p id="success-message" data-lang="it">La tua prenotazione √® stata confermata. Riceverai una email di conferma a breve.</p>
        <p id="success-message-en" class="hidden" data-lang="en">Your booking has been confirmed. You will receive a confirmation email shortly.</p>
        <button onclick="window.location.href='index.html'" class="primary">
          <span data-lang="it">Torna alla Home</span>
          <span class="hidden" data-lang="en">Back to Home</span>
        </button>
      </div>

      <!-- Payment Form (Visible by default) -->
      <div id="payment-form-container">
        <hgroup style="text-align: center; margin-bottom: 2rem;">
          <h1 data-lang="it">Completa il Pagamento</h1>
          <h1 class="hidden" data-lang="en">Complete Payment</h1>
          <p data-lang="it">Scegli il metodo di pagamento preferito</p>
          <p class="hidden" data-lang="en">Choose your preferred payment method</p>
        </hgroup>

        <!-- Booking Summary -->
        <div class="booking-summary">
          <h3 data-lang="it">Riepilogo Prenotazione</h3>
          <h3 class="hidden" data-lang="en">Booking Summary</h3>
          <div id="booking-details">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Total Section -->
        <div class="total-section">
          <h2 data-lang="it">Totale da Pagare</h2>
          <h2 class="hidden" data-lang="en">Total Amount</h2>
          <div id="total-amount" style="font-size: 1.8rem; font-weight: bold;">‚Ç¨0</div>
        </div>

        <!-- Payment Methods -->
        <div class="payment-methods">
          <!-- Saved Methods (dynamic) -->
          <div id="saved-methods" style="display:none;">
            <h4 data-lang="it">Metodi salvati</h4>
            <h4 class="hidden" data-lang="en">Saved methods</h4>
            <div id="saved-methods-list" class="payment-methods" style="margin: .5rem 0 1rem 0;"></div>
          </div>
          <!-- Credit Card -->
          <div class="payment-method" onclick="selectPaymentMethod('card')">
            <input type="radio" name="payment-method" value="card" id="payment-card">
            <div class="payment-icon">üí≥</div>
            <div class="payment-details">
              <h4 data-lang="it">Carta di Credito/Debito</h4>
              <h4 class="hidden" data-lang="en">Credit/Debit Card</h4>
              <p data-lang="it">Visa, Mastercard, American Express</p>
              <p class="hidden" data-lang="en">Visa, Mastercard, American Express</p>
            </div>
          </div>

          <!-- PayPal -->
          <div class="payment-method" onclick="selectPaymentMethod('paypal')">
            <input type="radio" name="payment-method" value="paypal" id="payment-paypal">
            <div class="payment-icon">üÖøÔ∏è</div>
            <div class="payment-details">
              <h4>PayPal</h4>
              <p data-lang="it">Paga in modo sicuro con il tuo account PayPal</p>
              <p class="hidden" data-lang="en">Pay securely with your PayPal account</p>
            </div>
          </div>

          <!-- Bank Transfer -->
          <div class="payment-method" onclick="selectPaymentMethod('transfer')">
            <input type="radio" name="payment-method" value="transfer" id="payment-transfer">
            <div class="payment-icon">üè¶</div>
            <div class="payment-details">
              <h4 data-lang="it">Bonifico Bancario</h4>
              <h4 class="hidden" data-lang="en">Bank Transfer</h4>
              <p data-lang="it">Riceverai le coordinate bancarie via email</p>
              <p class="hidden" data-lang="en">You will receive bank details via email</p>
            </div>
          </div>
        </div>

  <!-- Credit Card Form -->
        <div id="card-form" class="payment-form">
          <h4 data-lang="it">Dettagli Carta di Credito</h4>
          <h4 class="hidden" data-lang="en">Credit Card Details</h4>
          <form id="creditCardForm">
            <div class="form-group">
              <label for="cardNumber" data-lang="it">Numero Carta</label>
              <label for="cardNumber" class="hidden" data-lang="en">Card Number</label>
              <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="expiryDate" data-lang="it">Data Scadenza</label>
                <label for="expiryDate" class="hidden" data-lang="en">Expiry Date</label>
                <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5" required>
              </div>
              <div class="form-group">
                <label for="cvv" data-lang="it">CVV</label>
                <label for="cvv" class="hidden" data-lang="en">CVV</label>
                <input type="text" id="cvv" placeholder="123" maxlength="3" required>
              </div>
            </div>
            <div class="form-group">
              <label for="cardName" data-lang="it">Nome sulla Carta</label>
              <label for="cardName" class="hidden" data-lang="en">Name on Card</label>
              <input type="text" id="cardName" placeholder="Mario Rossi" required>
            </div>
            <label style="display:flex; gap:.5rem; align-items:center; margin-top:.5rem;">
              <input type="checkbox" id="save-card-for-future"> <span data-lang="it">Salva per prenotazioni future</span><span class="hidden" data-lang="en">Save for future bookings</span>
            </label>
          </form>
        </div>

        <!-- PayPal Form -->
        <div id="paypal-form" class="payment-form">
          <form id="paypalForm">
            <div class="form-group" style="text-align:center;">
              <div style="font-size: 4rem; margin-bottom: 1rem;">üÖøÔ∏è</div>
              <h4>PayPal</h4>
              <p data-lang="it">Inserisci la tua email PayPal</p>
              <p class="hidden" data-lang="en">Enter your PayPal email</p>
            </div>
            <div class="form-group">
              <label>Email PayPal</label>
              <input type="email" id="paypalEmail" placeholder="nome@email.com" />
            </div>
            <label style="display:flex; gap:.5rem; align-items:center; margin-top:.5rem;">
              <input type="checkbox" id="save-paypal-for-future"> <span data-lang="it">Salva per prenotazioni future</span><span class="hidden" data-lang="en">Save for future bookings</span>
            </label>
          </form>
        </div>

        <!-- Bank Transfer Form -->
        <div id="transfer-form" class="payment-form">
          <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üè¶</div>
            <h4 data-lang="it">Bonifico Bancario</h4>
            <h4 class="hidden" data-lang="en">Bank Transfer</h4>
            <p data-lang="it">Riceverai via email le coordinate bancarie per effettuare il bonifico. La prenotazione sar√† confermata al ricevimento del pagamento.</p>
            <p class="hidden" data-lang="en">You will receive bank details via email to make the transfer. The booking will be confirmed upon receipt of payment.</p>
          </div>
        </div>

        <!-- Payment Button -->
        <div style="text-align: center; margin-top: 2rem;">
          <button id="pay-button" onclick="processPayment()" disabled class="primary" style="font-size: 1.2rem; padding: 1rem 2rem;">
            <span data-lang="it">Seleziona Metodo di Pagamento</span>
            <span class="hidden" data-lang="en">Select Payment Method</span>
          </button>
        </div>

        <div class="secure-payment">
          <span data-lang="it">üîí Pagamento sicuro e crittografato</span>
          <span class="hidden" data-lang="en">üîí Secure and encrypted payment</span>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer with contact info -->
  <footer class="container" style="margin-top: 2rem; padding: 1.5rem; border-top: 1px solid var(--border-color); text-align: center; background: var(--card-background-color); border-radius: 8px;">
    <h4 style="margin-bottom: 1rem;" data-lang="it">Hai bisogno di aiuto?</h4>
    <h4 class="hidden" style="margin-bottom: 1rem;" data-lang="en">Need help?</h4>
    <div style="display: flex; gap: 1.5rem; justify-content: center; align-items: center; flex-wrap: wrap;">
      <a href="https://wa.me/393758843175" target="_blank" style="color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: 1px solid var(--primary); border-radius: 8px; transition: background-color 0.3s;">
        <img src="./attached_assets/icons8-whatsapp-30.png" alt="WhatsApp" style="width: 20px; height: 20px;">
        <span>WhatsApp</span>
      </a>
      <a href="tel:+393758843175" style="color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: 1px solid var(--primary); border-radius: 8px; transition: background-color 0.3s;">
        <span style="font-size: 20px;">üìû</span>
        <span>+39 375 884 3175</span>
      </a>
      <a href="mailto:info@aurooms.it" style="color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: 1px solid var(--primary); border-radius: 8px; transition: background-color 0.3s;">
        <span style="font-size: 20px;">üìß</span>
        <span>info@aurooms.it</span>
      </a>
    </div>
  </footer>

  <!-- WhatsApp Floating Button -->
  <a class="whatsapp-button" href="https://wa.me/393758843175" target="_blank" title="Contattaci su WhatsApp">
  <img src="./attached_assets/icons8-whatsapp-30.png" alt="WhatsApp" style="width: 32px; height: 32px;">
  </a>

  <script src="script.js"></script>
  <script>
    // Inizializza EmailJS
    (function(){
      emailjs.init("JdlaY1LThC-wKEczu"); // La tua chiave pubblica EmailJS
    })();
    
  let selectedPaymentMethod = null;
  let selectedSavedIndex = null;
    
    function getUserPMKey() {
      const user = JSON.parse(localStorage.getItem('aurooms_current_user')||'{}');
      return user.email ? `au_pm_${user.email}` : null;
    }
    function getSavedPaymentMethods() {
      const key = getUserPMKey();
      if (!key) return [];
      return JSON.parse(localStorage.getItem(key) || '[]');
    }
    function renderSavedMethods() {
      const saved = getSavedPaymentMethods();
      const wrap = document.getElementById('saved-methods');
      const list = document.getElementById('saved-methods-list');
      if (!wrap || !list) return;
      if (!saved.length) { wrap.style.display = 'none'; return; }
      wrap.style.display = 'block';
      list.innerHTML = '';
      saved.forEach((pm, idx) => {
        const el = document.createElement('div');
        el.className = 'payment-method' + (pm.default ? ' selected' : '');
        el.onclick = () => selectSavedMethod(idx);
        el.innerHTML = `
          <input type="radio" name="payment-method" value="saved-${idx}">
          <div class="payment-icon">${pm.type==='paypal'?'üÖøÔ∏è':'üí≥'}</div>
          <div class="payment-details">
            <h4>${pm.type==='paypal'?'PayPal':'Carta'} ${pm.default?'‚Ä¢ Predefinito':''}</h4>
            <p>${pm.type==='paypal'?(pm.email||''):(pm.mask||'‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢')}</p>
          </div>`;
        list.appendChild(el);
      });
    }
    function selectSavedMethod(idx) {
      selectedSavedIndex = idx;
      selectedPaymentMethod = 'saved';
      document.querySelectorAll('.payment-form').forEach(f=>f.classList.remove('active'));
      updatePaymentButton();
    }
    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      
      // Update radio buttons
      document.querySelectorAll('.payment-method input[type="radio"]').forEach(radio => {
        radio.checked = radio.value === method;
      });
      
      // Update visual selection
      document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('selected');
      });
      document.querySelector(`#payment-${method}`).closest('.payment-method').classList.add('selected');
      
      // Show appropriate form
      document.querySelectorAll('.payment-form').forEach(form => {
        form.classList.remove('active');
      });
      if (document.getElementById(`${method}-form`)) {
        document.getElementById(`${method}-form`).classList.add('active');
      }
      
      // Update button
      updatePaymentButton();
    }
    
    function updatePaymentButton() {
      const button = document.getElementById('pay-button');
      if (selectedPaymentMethod) {
        button.disabled = false;
        
        if (selectedPaymentMethod === 'saved') {
          button.innerHTML = getCurrentLanguage() === 'it' ? '‚úÖ Usa metodo salvato' : '‚úÖ Use saved method';
        } else if (selectedPaymentMethod === 'card') {
          button.innerHTML = getCurrentLanguage() === 'it' ? 
            'üí≥ Paga con Carta' : 'üí≥ Pay with Card';
        } else if (selectedPaymentMethod === 'paypal') {
          button.innerHTML = 'üÖøÔ∏è Paga con PayPal';
        } else if (selectedPaymentMethod === 'transfer') {
          button.innerHTML = getCurrentLanguage() === 'it' ? 
            'üè¶ Conferma Bonifico' : 'üè¶ Confirm Transfer';
        }
      } else {
        button.disabled = true;
        button.innerHTML = getCurrentLanguage() === 'it' ? 
          'Seleziona Metodo di Pagamento' : 'Select Payment Method';
      }
    }
    
    function processPayment() {
      if (!selectedPaymentMethod) {
        alert(getCurrentLanguage() === 'it' ? 
          'Seleziona un metodo di pagamento' : 'Please select a payment method');
        return;
      }
      
      const button = document.getElementById('pay-button');
      button.disabled = true;
      
      // Handle different payment methods
      if (selectedPaymentMethod === 'saved') {
        const saved = getSavedPaymentMethods();
        const pm = saved[selectedSavedIndex] || saved.find(p=>p.default) || saved[0];
        if (!pm) { alert('Metodo salvato non disponibile'); button.disabled=false; updatePaymentButton(); return; }
        // Procedi come se fosse carta o PayPal a seconda del tipo salvato
        selectedPaymentMethod = pm.type === 'paypal' ? 'paypal' : 'card';
        processPayment();
        return;
      } else if (selectedPaymentMethod === 'paypal') {
        // PayPal redirect
        button.innerHTML = getCurrentLanguage() === 'it' ? 
          'üÖøÔ∏è Reindirizzamento a PayPal...' : 'üÖøÔ∏è Redirecting to PayPal...';
        
        setTimeout(() => {
          // Salva PayPal se richiesto
          const savePP = document.getElementById('save-paypal-for-future')?.checked;
          const ppEmail = document.getElementById('paypalEmail')?.value;
          if (savePP && ppEmail && /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(ppEmail)) {
            const user = JSON.parse(localStorage.getItem('aurooms_current_user')||'{}');
            if (user.email) {
              const key = `au_pm_${user.email}`;
              const list = JSON.parse(localStorage.getItem(key)||'[]');
              list.push({ type:'paypal', label:'PayPal', email: ppEmail, default: list.length===0 });
              localStorage.setItem(key, JSON.stringify(list));
            }
          }
          // Simulate PayPal redirect
          const paypalUrl = `https://www.paypal.com/checkout?amount=${getBookingTotal()}&currency=EUR&item_name=AUROOMS%20Booking`;
          window.open(paypalUrl, '_blank');
          
          // Show success after redirect
          setTimeout(() => {
            showPaymentSuccess();
          }, 3000);
        }, 1500);
        
  } else if (selectedPaymentMethod === 'transfer') {
        // Bank transfer with email
        button.innerHTML = getCurrentLanguage() === 'it' ? 
          'üìß Invio istruzioni...' : 'üìß Sending instructions...';
        
        setTimeout(() => {
          sendBankTransferEmail();
          showPaymentSuccess();
        }, 2000);
        
      } else if (selectedPaymentMethod === 'card') {
        // Credit card validation and processing
        if (!validateCreditCard()) {
          button.disabled = false;
          updatePaymentButton();
          return;
        }
        // Salva carta se richiesto
        const saveForFuture = document.getElementById('save-card-for-future')?.checked;
        if (saveForFuture) {
          const num = document.getElementById('cardNumber').value.replace(/\s/g,'');
          const exp = document.getElementById('expiryDate').value;
          const mask = `‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${num.slice(-4)}`;
          const key = getUserPMKey();
          if (key) {
            const list = JSON.parse(localStorage.getItem(key)||'[]');
            list.push({ type:'card', label:'Carta', mask, exp, default: list.length===0 });
            localStorage.setItem(key, JSON.stringify(list));
          }
        }
        
        button.innerHTML = getCurrentLanguage() === 'it' ? 
          'üí≥ Elaborazione pagamento...' : 'üí≥ Processing payment...';
        
        setTimeout(() => {
          showPaymentSuccess();
        }, 3000);
      }
    }
    
    function validateCreditCard() {
      const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
      const expiryDate = document.getElementById('expiryDate').value;
      const cvv = document.getElementById('cvv').value;
      const cardName = document.getElementById('cardName').value;
      
      if (!cardNumber || cardNumber.length < 13) {
        alert(getCurrentLanguage() === 'it' ? 
          'Inserisci un numero di carta valido' : 'Please enter a valid card number');
        return false;
      }
      
      if (!expiryDate || expiryDate.length !== 5) {
        alert(getCurrentLanguage() === 'it' ? 
          'Inserisci una data di scadenza valida (MM/YY)' : 'Please enter a valid expiry date (MM/YY)');
        return false;
      }
      
      if (!cvv || cvv.length < 3) {
        alert(getCurrentLanguage() === 'it' ? 
          'Inserisci un CVV valido' : 'Please enter a valid CVV');
        return false;
      }
      
      if (!cardName.trim()) {
        alert(getCurrentLanguage() === 'it' ? 
          'Inserisci il nome sulla carta' : 'Please enter the name on card');
        return false;
      }
      
      return true;
    }
    
    function sendBankTransferEmail() {
      const bookingData = JSON.parse(sessionStorage.getItem('pending_booking'));
      const currentUser = JSON.parse(localStorage.getItem('aurooms_current_user'));
      
      // Parametri per l'email
      const templateParams = {
        to_name: currentUser.name,
        to_email: currentUser.email,
        customer_name: currentUser.name,
        room_name: bookingData.roomName,
        checkin_date: new Date(bookingData.checkin).toLocaleDateString('it-IT'),
        checkout_date: new Date(bookingData.checkout).toLocaleDateString('it-IT'),
        nights: bookingData.nights,
        guests: bookingData.guests,
        price_per_night: bookingData.pricePerNight,
        total_amount: bookingData.totalPrice,
        iban: localStorage.getItem('bank_iban') || "IT60 X054 2811 1010 0000 0123 456",
        bic: localStorage.getItem('bank_bic') || "BPMOIT22XXX",
        account_holder: localStorage.getItem('bank_holder') || "AUROOMS Guest House",
        booking_reference: `BOOK-${Date.now()}`,
        logo_url: window.location.origin + '/attached_assets/logo_aurooms.jpg',
        company_name: 'AUROOMS Guest House'
      };
      
      console.log('ÔøΩ Invio email reale a:', currentUser.email);
      
      // Invio email tramite EmailJS (con destinatario esplicito)
      const emailParams = {
        ...templateParams,
        to_name: currentUser.name,
        to_email: currentUser.email,
        from_name: 'AUROOMS Guest House',
        reply_to: 'info@aurooms.it'
      };
      
      emailjs.send('service_oiuox5y', 'bank_transfer_template', emailParams)
        .then(function(response) {
          console.log('‚úÖ Email inviata con successo!', response.status, response.text);
          
          // Invia copia all'admin
          sendAdminCopyEmail({
            name: currentUser.name,
            email: currentUser.email,
            phone: currentUser.phone || 'N/D',
            checkin: bookingData.checkin,
            checkout: bookingData.checkout,
            guests: bookingData.guests,
            room: bookingData.roomName,
            total: bookingData.totalPrice,
            id: templateParams.booking_reference,
            payment: 'Bonifico Bancario'
          });
          
          // Mostra conferma successo
          alert(getCurrentLanguage() === 'it' ? 
            `‚úÖ Email inviata con successo a ${currentUser.email}!\n\nüè¶ Le coordinate bancarie sono state inviate.\nüìß Controlla la tua casella di posta.\n\nüí∞ Importo da pagare: ‚Ç¨${bookingData.totalPrice}\nüî¢ Riferimento: ${templateParams.booking_reference}` :
            `‚úÖ Email sent successfully to ${currentUser.email}!\n\nüè¶ Bank details have been sent.\nüìß Please check your email.\n\nüí∞ Amount to pay: ‚Ç¨${bookingData.totalPrice}\nüî¢ Reference: ${templateParams.booking_reference}`
          );
          
        }, function(error) {
          console.error('‚ùå Errore invio email:', error);
          
          // Ottieni coordinate bancarie aggiornate
          const bankIban = localStorage.getItem('bank_iban') || "IT60 X054 2811 1010 0000 0123 456";
          const bankBic = localStorage.getItem('bank_bic') || "BPMOIT22XXX";
          const bankHolder = localStorage.getItem('bank_holder') || "AUROOMS Guest House";
          
          // Fallback con alert se l'invio fallisce
          alert(getCurrentLanguage() === 'it' ? 
            `‚ö†Ô∏è Problema nell'invio automatico dell'email.\n\nEcco le coordinate bancarie:\n\nüè¶ IBAN: ${bankIban}\nüè¶ BIC: ${bankBic}\nüè¶ Intestatario: ${bankHolder}\nüí∞ Importo: ‚Ç¨${bookingData.totalPrice}\nüìù Causale: Prenotazione ${bookingData.roomName}\nüî¢ Riferimento: ${templateParams.booking_reference}\n\nüìß Ti contatteremo via email a breve.` :
            `‚ö†Ô∏è Problem sending automatic email.\n\nHere are the bank details:\n\nüè¶ IBAN: ${bankIban}\nüè¶ BIC: ${bankBic}\nüè¶ Account holder: ${bankHolder}\nüí∞ Amount: ‚Ç¨${bookingData.totalPrice}\nüìù Reference: Booking ${bookingData.roomName}\nüî¢ Booking ref: ${templateParams.booking_reference}\n\nüìß We will contact you via email shortly.`
          );
        });
    }
    
  function sendConfirmationEmail(paymentMethod, refOverride) {
      const bookingData = JSON.parse(sessionStorage.getItem('pending_booking'));
      const currentUser = JSON.parse(localStorage.getItem('aurooms_current_user'));
      
      if (!currentUser || !currentUser.email) {
        console.log('üìß Nessun utente o email trovata per l\'invio della conferma');
        return;
      }
      
  const bookingRef = refOverride || `CONF-${Date.now()}`;
  const templateParams = {
        to_name: currentUser.name,
        to_email: currentUser.email,
        customer_name: currentUser.name,
        room_name: bookingData.roomName,
        checkin_date: new Date(bookingData.checkin).toLocaleDateString('it-IT'),
        checkout_date: new Date(bookingData.checkout).toLocaleDateString('it-IT'),
        nights: bookingData.nights,
        guests: bookingData.guests,
        total_amount: bookingData.totalPrice,
        payment_method: paymentMethod === 'card' ? 'Carta di Credito' : 
                      paymentMethod === 'paypal' ? 'PayPal' : 'Bonifico Bancario',
  booking_reference: bookingRef,
        logo_url: window.location.origin + '/attached_assets/logo_aurooms.jpg',
        company_name: 'AUROOMS Guest House',
        to_name: currentUser.name,
        to_email: currentUser.email,
        from_name: 'AUROOMS Guest House',
        reply_to: 'info@aurooms.it'
      };
      
      // Invio email di conferma
      emailjs.send('service_oiuox5y', 'payment_confirmation', templateParams)
        .then(function(response) {
          console.log('‚úÖ Email di conferma inviata!', response.status);
          
          // Invia copia all'admin
          sendAdminCopyEmail({
            name: currentUser.name,
            email: currentUser.email,
            phone: currentUser.phone || 'N/D',
            checkin: bookingData.checkin,
            checkout: bookingData.checkout,
            guests: bookingData.guests,
            room: bookingData.roomName,
            total: bookingData.totalPrice,
            id: templateParams.booking_reference,
            payment: templateParams.payment_method
          });
          
        }, function(error) {
          console.error('‚ùå Errore invio email conferma:', error);
        });
    }
    
    function getBookingTotal() {
      const bookingData = sessionStorage.getItem('pending_booking');
      if (bookingData) {
        const booking = JSON.parse(bookingData);
        return booking.totalPrice || 0;
      }
      return 0;
    }
    
    function showPaymentSuccess() {
      // Per bonifico bancario NON inviare subito conferma pagamento
      if (selectedPaymentMethod !== 'transfer') {
        // Solo per carta e PayPal invia conferma immediata
        const bookingData = JSON.parse(sessionStorage.getItem('pending_booking'));
        const currentUser = JSON.parse(localStorage.getItem('aurooms_current_user'));
        const ref = `CONF-${Date.now()}`;
        sendConfirmationEmail(selectedPaymentMethod, ref);

        // Salva come prenotazione confermata
        const confirmed = JSON.parse(localStorage.getItem('aurooms_confirmed_bookings') || '[]');
        confirmed.push({
          roomName: bookingData.roomName,
          checkin: bookingData.checkin,
          checkout: bookingData.checkout,
          nights: bookingData.nights,
          guests: bookingData.guests,
          totalPrice: bookingData.totalPrice,
          status: 'confirmed',
          paymentMethod: selectedPaymentMethod === 'card' ? 'card' : 'paypal',
          customerEmail: currentUser.email,
          bookingDate: new Date().toISOString(),
          confirmationDate: new Date().toISOString(),
          bookingReference: ref
        });
        localStorage.setItem('aurooms_confirmed_bookings', JSON.stringify(confirmed));
        
        // Messaggio standard per pagamenti immediati
        document.getElementById('success-title').textContent = 
          getCurrentLanguage() === 'it' ? 'Pagamento Completato!' : 'Payment Completed!';
        document.getElementById('success-title-en').textContent = 'Payment Completed!';
        document.getElementById('success-message').textContent = 
          getCurrentLanguage() === 'it' ? 
          'La tua prenotazione √® stata confermata. Riceverai una email di conferma a breve.' :
          'Your booking has been confirmed. You will receive a confirmation email shortly.';
        document.getElementById('success-message-en').textContent = 
          'Your booking has been confirmed. You will receive a confirmation email shortly.';
          
      } else {
        // Per bonifico, salva prenotazione come "pending"
        const bookingData = JSON.parse(sessionStorage.getItem('pending_booking'));
        const currentUser = JSON.parse(localStorage.getItem('aurooms_current_user'));
        
        const pendingBooking = {
          ...bookingData,
          status: 'pending_payment',
          paymentMethod: 'transfer',
          customerEmail: currentUser.email,
          bookingDate: new Date().toISOString(),
          bookingReference: `BOOK-${Date.now()}`
        };
        
        // Salva in localStorage per gestione amministrativa
        let pendingBookings = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
        pendingBookings.push(pendingBooking);
        localStorage.setItem('aurooms_pending_bookings', JSON.stringify(pendingBookings));
        
        // Messaggio specifico per bonifico bancario
        document.getElementById('success-title').textContent = 
          getCurrentLanguage() === 'it' ? 'Richiesta Bonifico Inviata!' : 'Bank Transfer Request Sent!';
        document.getElementById('success-title-en').textContent = 'Bank Transfer Request Sent!';
        document.getElementById('success-message').textContent = 
          getCurrentLanguage() === 'it' ? 
          'Hai ricevuto le coordinate bancarie via email. La prenotazione sar√† confermata dopo aver ricevuto il pagamento.' :
          'You received bank details via email. The booking will be confirmed after receiving payment.';
        document.getElementById('success-message-en').textContent = 
          'You received bank details via email. The booking will be confirmed after receiving payment.';
        
        console.log('üíº Prenotazione salvata come pending:', pendingBooking.bookingReference);
      }
      
      // Hide payment form and show success
      document.getElementById('payment-form-container').style.display = 'none';
      document.getElementById('success-animation').classList.add('show');
      
      // Clear session data
      sessionStorage.removeItem('pending_booking');
      
      // Log successful payment
      console.log('‚úÖ Pagamento completato con metodo:', selectedPaymentMethod);
    }
    
    // ========== GESTIONE ADMIN BONIFICI ==========
    
    function confirmBankTransfer(bookingReference) {
      // Funzione per confermare manualmente un bonifico (uso amministrativo)
      let pendingBookings = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
      const bookingIndex = pendingBookings.findIndex(b => b.bookingReference === bookingReference);
      
      if (bookingIndex === -1) {
        console.error('‚ùå Prenotazione non trovata:', bookingReference);
        return false;
      }
      
      const booking = pendingBookings[bookingIndex];
      
      // Invia email di conferma pagamento
      const templateParams = {
        to_name: booking.customerEmail.split('@')[0], // Usa parte email come nome se manca
        to_email: booking.customerEmail,
        customer_name: booking.customerEmail.split('@')[0],
        room_name: booking.roomName,
        checkin_date: new Date(booking.checkin).toLocaleDateString('it-IT'),
        checkout_date: new Date(booking.checkout).toLocaleDateString('it-IT'),
        nights: booking.nights,
        guests: booking.guests,
        total_amount: booking.totalPrice,
        payment_method: 'Bonifico Bancario',
        booking_reference: booking.bookingReference,
        logo_url: window.location.origin + '/attached_assets/logo_aurooms.jpg',
        company_name: 'AUROOMS Guest House',
        from_name: 'AUROOMS Guest House',
        reply_to: 'info@aurooms.it'
      };
      
      emailjs.send('service_oiuox5y', 'payment_confirmation', templateParams)
        .then(function(response) {
          console.log('‚úÖ Conferma bonifico inviata!', response.status);
          
          // Rimuovi dalla lista pending
          pendingBookings.splice(bookingIndex, 1);
          localStorage.setItem('aurooms_pending_bookings', JSON.stringify(pendingBookings));
          
          // Aggiungi alla lista confermati
          let confirmedBookings = JSON.parse(localStorage.getItem('aurooms_confirmed_bookings') || '[]');
          confirmedBookings.push({
            ...booking,
            status: 'confirmed',
            confirmationDate: new Date().toISOString()
          });
          localStorage.setItem('aurooms_confirmed_bookings', JSON.stringify(confirmedBookings));
          
          alert(`‚úÖ Bonifico confermato per prenotazione ${bookingReference}\nüìß Email di conferma inviata a ${booking.customerEmail}`);
          
        }, function(error) {
          console.error('‚ùå Errore invio conferma bonifico:', error);
          alert(`‚ùå Errore nell'invio della conferma per ${bookingReference}`);
        });
      
      return true;
    }
    
    function listPendingTransfers() {
      // Funzione per visualizzare bonifici in attesa (uso amministrativo)
      const pendingBookings = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
      
      if (pendingBookings.length === 0) {
        console.log('üìã Nessun bonifico in attesa');
        return;
      }
      
      console.log('üìã BONIFICI IN ATTESA:');
      pendingBookings.forEach(booking => {
        console.log(`
üî∑ ${booking.bookingReference}
   üìß Cliente: ${booking.customerEmail}
   üè† Camera: ${booking.roomName}
   üìÖ ${new Date(booking.checkin).toLocaleDateString('it-IT')} ‚Üí ${new Date(booking.checkout).toLocaleDateString('it-IT')}
   üí∞ Importo: ‚Ç¨${booking.totalPrice}
   ‚è∞ Richiesto: ${new Date(booking.bookingDate).toLocaleString('it-IT')}
   ‚ñ∂Ô∏è Per confermare: confirmBankTransfer('${booking.bookingReference}')
        `);
      });
    }
    
    // ========== FINE GESTIONE ADMIN ==========
    
    // FUNZIONE HELPER: Invia copia email all'admin
    function sendAdminCopyEmail(bookingData) {
      const adminEmail = localStorage.getItem('admin_email');
      if (!adminEmail) {
        console.log('üìß Nessuna email admin configurata - salta invio copia');
        return Promise.resolve();
      }
      
      // Template parametri per copia admin
      const adminParams = {
        to_name: 'Amministratore AuRooms',
        to_email: adminEmail,
        from_name: 'Sistema AuRooms',
        customer_name: bookingData.name || 'Cliente',
        customer_email: bookingData.email || 'N/D',
        customer_phone: bookingData.phone || 'N/D',
        checkin_date: bookingData.checkin || 'N/D',
        checkout_date: bookingData.checkout || 'N/D',
        guests: bookingData.guests || 'N/D',
        room_type: bookingData.room || 'N/D',
        total_amount: bookingData.total || 'N/D',
        booking_id: bookingData.id || 'N/D',
        payment_method: bookingData.payment || 'N/D',
        booking_date: new Date().toLocaleString('it-IT'),
        logo_url: window.location.origin + '/attached_assets/logo_aurooms.jpg',
        company_name: 'AUROOMS Guest House',
        to_name: 'Amministratore AUROOMS',
        to_email: 'aurooms.bookings@gmail.com',
        from_name: 'Sistema AUROOMS',
        reply_to: bookingData.email
      };
      
      return emailjs.send('service_oiuox5y', 'template_admin_copy', adminParams)
        .then(function(response) {
          console.log('‚úÖ Copia admin inviata:', response);
        })
        .catch(function(error) {
          console.error('‚ùå Errore copia admin:', error);
        });
    }

    function getCurrentLanguage() {
      return localStorage.getItem('aurooms_language') || 'it';
    }
    
    function switchLang(lang) {
      localStorage.setItem('aurooms_language', lang);
      document.querySelectorAll('[data-lang]').forEach(el => {
        if (el.getAttribute('data-lang') === lang) {
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      });
      updatePaymentButton();
    }
    
    function loadBookingDetails() {
      const bookingData = sessionStorage.getItem('pending_booking');
      
      // Se non ci sono dati di prenotazione, crea dati di test
      if (!bookingData) {
        console.warn('Nessun dato di prenotazione trovato, creazione dati di test...');
        
        // Crea una prenotazione di test
        const testBooking = {
          roomName: "Camera Familiare",
          checkin: new Date().toISOString().split('T')[0],
          checkout: new Date(Date.now() + 2 * 86400000).toISOString().split('T')[0], // +2 days
          guests: 2,
          nights: 2,
          pricePerNight: 110
          // totalPrice verr√† calcolato automaticamente
        };
        
        sessionStorage.setItem('pending_booking', JSON.stringify(testBooking));
        console.log('üìã Dati di test creati:', testBooking);
      }
      
      // Ricarica i dati (ora dovrebbero esserci)
      const booking = JSON.parse(sessionStorage.getItem('pending_booking'));
      const bookingDetails = document.getElementById('booking-details');
      const totalAmount = document.getElementById('total-amount');
      
      // Assicurati che i dati essenziali esistano
      if (!booking.roomName) booking.roomName = "Camera Familiare";
      if (!booking.pricePerNight) booking.pricePerNight = 110;
      if (!booking.guests) booking.guests = 2;
      if (!booking.checkin) booking.checkin = new Date().toISOString().split('T')[0];
      if (!booking.checkout) booking.checkout = new Date(Date.now() + 2 * 86400000).toISOString().split('T')[0];
      
      // CALCOLA LE NOTTI SE MANCANTI
      if (!booking.nights && booking.checkin && booking.checkout) {
        const checkinDate = new Date(booking.checkin);
        const checkoutDate = new Date(booking.checkout);
        const timeDiff = checkoutDate.getTime() - checkinDate.getTime();
        booking.nights = Math.max(1, Math.ceil(timeDiff / (1000 * 3600 * 24)));
      }
      if (!booking.nights) booking.nights = 2; // fallback
      
      // CALCOLA IL TOTALE DINAMICAMENTE (usa motore prezzi da script.js se disponibile)
      try {
        if (typeof calculateDynamicTotal === 'function') {
          booking.totalPrice = calculateDynamicTotal(booking.pricePerNight, booking.checkin, booking.checkout, booking.nights);
        } else {
          booking.totalPrice = booking.pricePerNight * booking.nights;
        }
      } catch (e) {
        console.warn('Errore calcolo prezzi dinamici, uso fallback:', e);
        booking.totalPrice = booking.pricePerNight * booking.nights;
      }
      
      // Salva i dati aggiornati
      sessionStorage.setItem('pending_booking', JSON.stringify(booking));
      
      // Format dates
      const checkinDate = new Date(booking.checkin).toLocaleDateString('it-IT');
      const checkoutDate = new Date(booking.checkout).toLocaleDateString('it-IT');
      
      bookingDetails.innerHTML = `
        <div style="display: grid; gap: 0.5rem;">
          <div style="display: flex; justify-content: space-between;">
            <strong data-lang="it">Camera:</strong>
            <strong class="hidden" data-lang="en">Room:</strong>
            <span>${booking.roomName}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span data-lang="it">Check-in:</span>
            <span class="hidden" data-lang="en">Check-in:</span>
            <span>${checkinDate}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span data-lang="it">Check-out:</span>
            <span class="hidden" data-lang="en">Check-out:</span>
            <span>${checkoutDate}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span data-lang="it">Ospiti:</span>
            <span class="hidden" data-lang="en">Guests:</span>
            <span>${booking.guests}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span data-lang="it">Notti:</span>
            <span class="hidden" data-lang="en">Nights:</span>
            <span>${booking.nights}</span>
          </div>
          <hr style="border-color: #4a5568;">
          <div style="display: flex; justify-content: space-between;">
            <span data-lang="it">Prezzo per notte:</span>
            <span class="hidden" data-lang="en">Price per night:</span>
            <span>‚Ç¨${booking.pricePerNight}</span>
          </div>
        </div>
      `;
      
      // Set total amount with proper formatting
      totalAmount.textContent = `‚Ç¨${booking.totalPrice}`;
      
      console.log('üìã Dati prenotazione caricati:', booking);
    }
    
    // Format card number with spaces
  document.addEventListener('DOMContentLoaded', function() {
      const currentLang = getCurrentLanguage();
      switchLang(currentLang);
      
      // Login obbligatorio
      const currentUser = localStorage.getItem('aurooms_current_user');
      if (!currentUser) {
        sessionStorage.setItem('returnUrl', 'pagamento.html');
        alert(currentLang==='it' ? 'Effettua l\'accesso per completare il pagamento' : 'Please log in to complete payment');
        window.location.href = 'login.html';
        return;
      }
      
  loadBookingDetails();
  renderSavedMethods();
      
      // Format card number input
      const cardNumberInput = document.getElementById('cardNumber');
      if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\s/g, '');
          let formattedValue = value.replace(/(.{4})/g, '$1 ').trim();
          if (formattedValue.length > 19) formattedValue = formattedValue.substring(0, 19);
          e.target.value = formattedValue;
        });
      }
      
      // Format expiry date
      const expiryInput = document.getElementById('expiryDate');
      if (expiryInput) {
        expiryInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
          }
          e.target.value = value;
        });
      }
      
      // CVV only numbers
      const cvvInput = document.getElementById('cvv');
      if (cvvInput) {
        cvvInput.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/\D/g, '');
        });
      }

  // Salvataggio PayPal on change (no-op, placeholder)
    });
  </script>
</body>
</html>
