<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin - AuRooms</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="style.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    .admin-layout { display: flex; min-height: 100vh; background: #f8f9fa; }
    .sidebar { width: 250px; background: #2d3748; color: white; padding: 2rem 0; }
    .sidebar h2 { padding: 0 2rem; margin-bottom: 2rem; color: #63b3ed; }
    .sidebar-menu { list-style: none; padding: 0; margin: 0; }
    .sidebar-menu a { 
      display: flex; align-items: center; gap: 0.75rem; padding: 1rem 2rem; 
      color: #a0aec0; text-decoration: none; transition: all 0.2s;
    }
    .sidebar-menu a:hover, .sidebar-menu a.active { background: #4a5568; color: white; }
    .main-content { flex: 1; padding: 2rem; }
    .header { 
      background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; 
      display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { 
      background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 4px solid #007bff;
    }
    .stat-number { font-size: 2rem; font-weight: bold; color: #2d3748; }
    .stat-label { color: #4a5568; font-size: 0.9rem; margin-top: 0.5rem; }
    .section { display: none; }
    .section.active { display: block; }
    .content-card { background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .btn-primary { background: #007bff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; }
    .btn-primary:hover { background: #0056b3; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748; }
    .form-group input { width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; }
  </style>
</head>
<body style="display: none;" id="admin-body">
  <div id="auth-loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2d3748; color: white; display: flex; align-items: center; justify-content: center; z-index: 9999;">
    <div style="text-align: center;">
      <div style="font-size: 2rem; margin-bottom: 1rem;">üîê</div>
      <div style="font-size: 1.2rem;">Verifica autenticazione...</div>
    </div>
  </div>

  <div class="admin-layout">
    <div class="sidebar">
      <div style="padding: 0 1rem; margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem;">
        <img src="./attached_assets/logo_aurooms.jpg" alt="AUROOMS Logo" style="height: 30px; width: auto; border-radius: 4px;">
        <h2 style="margin: 0; color: #63b3ed;">AuRooms Admin</h2>
      </div>
      <nav class="sidebar-menu">
        <a href="#" id="menu-dashboard" class="active" onclick="showSection('dashboard')">üìä Dashboard</a>
        <a href="#" id="menu-transfers" onclick="showSection('transfers')">üè¶ Bonifici</a>
        <a href="#" id="menu-settings" onclick="showSection('settings')">‚öôÔ∏è Impostazioni</a>
        <a href="#" onclick="logout()" style="margin-top: 2rem; color: #fc8181;">üö™ Logout</a>
      </nav>
    </div>

    <div class="main-content">
      <div class="header">
        <div>
          <h1 id="page-title">üìä Dashboard</h1>
          <p id="page-subtitle" style="margin: 0; color: #4a5568;">Panoramica generale del sistema</p>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 0.9rem; color: #4a5568;">Admin: <span id="admin-username">-</span></div>
          <div style="font-size: 0.8rem; color: #a0aec0;">${new Date().toLocaleString('it-IT')}</div>
        </div>
      </div>

      <!-- Dashboard Section -->
      <div id="section-dashboard" class="section active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="total-bookings">0</div>
            <div class="stat-label">Prenotazioni Totali</div>
          </div>
          <div class="stat-card" style="border-left-color: #ffc107;">
            <div class="stat-number" id="monthly-revenue">‚Ç¨0</div>
            <div class="stat-label">Ricavi Mese Corrente</div>
          </div>
          <div class="stat-card" style="border-left-color: #28a745;">
            <div class="stat-number" id="pending-transfers">0</div>
            <div class="stat-label">Bonifici in Attesa</div>
          </div>
          <div class="stat-card" style="border-left-color: #6f42c1;">
            <div class="stat-number" id="rooms-booked">0</div>
            <div class="stat-label">Camere Prenotate</div>
          </div>
          <div class="stat-card" style="border-left-color: #17a2b8;">
            <div class="stat-number" id="total-revenue">‚Ç¨0</div>
            <div class="stat-label">Ricavi Totali</div>
          </div>
          <div class="stat-card" style="border-left-color: #fd7e14;">
            <div class="stat-number" id="avg-booking-value">‚Ç¨0</div>
            <div class="stat-label">Valore Medio Prenotazione</div>
          </div>
          <div class="stat-card" style="border-left-color: #20c997;">
            <div class="stat-number" id="conversion-rate">0%</div>
            <div class="stat-label">Tasso di Conversione</div>
          </div>
        </div>

        <div class="content-card">
          <h3 style="color: #2d3748; margin-bottom: 1rem;">üìà Attivit√† Recente</h3>
          <div id="recent-activity">
            <p style="color: #4a5568; text-align: center;">Caricamento attivit√†...</p>
          </div>
        </div>
      </div>

      <!-- Transfers Section -->
      <div id="section-transfers" class="section">
        <div class="content-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h3 style="color: #2d3748; margin: 0;">üè¶ Gestione Bonifici</h3>
              <p style="color: #4a5568; margin: 0.5rem 0;" id="pending-amount">Caricamento...</p>
            </div>
          </div>
          <div id="transfers-content">
            <p style="color: #4a5568; text-align: center;">Caricamento bonifici...</p>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div id="section-settings" class="section">
        <div class="content-card">
          <h3 style="color: #2d3748; margin-bottom: 2rem;">üè¶ Coordinate Bancarie</h3>
          
          <div class="form-group">
            <label for="bank-iban">IBAN</label>
            <input type="text" id="bank-iban" placeholder="IT60 X054 2811 1010 0000 0123 456">
          </div>
          
          <div class="form-group">
            <label for="bank-bic">BIC/SWIFT</label>
            <input type="text" id="bank-bic" placeholder="BPMOIT22XXX">
          </div>
          
          <div class="form-group">
            <label for="bank-holder">Intestatario</label>
            <input type="text" id="bank-holder" placeholder="AUROOMS Guest House">
          </div>
          
          <button onclick="saveBankDetails()" class="btn-primary">üíæ Salva Coordinate</button>
        </div>

        <div class="content-card" style="margin-top: 1.5rem;">
          <h3 style="color: #2d3748; margin-bottom: 1rem;">üí∂ Prezzi Dinamici</h3>
          <p style="color:#4a5568; margin-top:0;">Configura sconti/aumenti per stagioni, weekend e soggiorni lunghi. I prezzi si applicano automaticamente nella ricerca e in pagamento.</p>

          <details open style="margin-bottom:1rem;">
            <summary><strong>Stagionalit√†</strong></summary>
            <div class="form-group" style="margin-top:1rem;">
              <label>Mesi Alta Stagione</label>
              <div id="high-months" style="display:flex; flex-wrap:wrap; gap:.5rem;"></div>
              <small style="color:#6c757d;">Seleziona i mesi con domanda alta (es. Giugno, Luglio, Agosto)</small>
            </div>
            <div class="form-group">
              <label>Variazione Alta Stagione (%)</label>
              <input type="number" id="high-percent" placeholder="es. 25" />
            </div>
            <div class="form-group">
              <label>Mesi Bassa Stagione</label>
              <div id="low-months" style="display:flex; flex-wrap:wrap; gap:.5rem;"></div>
            </div>
            <div class="form-group">
              <label>Variazione Bassa Stagione (%)</label>
              <input type="number" id="low-percent" placeholder="es. -20" />
            </div>
          </details>

          <details open style="margin-bottom:1rem;">
            <summary><strong>Weekend</strong></summary>
            <div class="form-group" style="margin-top:1rem;">
              <label>Giorni considerati weekend</label>
              <div id="weekend-days" style="display:flex; gap:.5rem; flex-wrap:wrap;"></div>
            </div>
            <div class="form-group">
              <label>Variazione Weekend (%)</label>
              <input type="number" id="weekend-percent" placeholder="es. 10" />
            </div>
          </details>

          <details open style="margin-bottom:1rem;">
            <summary><strong>Soggiorni lunghi</strong></summary>
            <div class="form-group" style="margin-top:1rem; display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
              <div>
                <label>Soglia notti</label>
                <input type="number" id="long-threshold" placeholder="es. 5" />
              </div>
              <div>
                <label>Variazione (%)</label>
                <input type="number" id="long-percent" placeholder="es. -10" />
              </div>
            </div>
          </details>

          <div class="form-group">
            <label>Arrotondamento</label>
            <select id="rounding-mode">
              <option value="round">Arrotonda per eccesso/difetto</option>
              <option value="floor">Sempre per difetto</option>
              <option value="ceil">Sempre per eccesso</option>
            </select>
          </div>

          <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
            <button onclick="savePricingSettings()" class="btn-primary">üíæ Salva Prezzi Dinamici</button>
            <button onclick="resetPricingSettings()" class="contrast">‚ôªÔ∏è Ripristina Default</button>
            <button onclick="previewPricing()" class="secondary">üîç Anteprima</button>
          </div>

          <div id="pricing-preview" style="margin-top:1rem; color:#2d3748;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Inizializza EmailJS
    (function(){
      emailjs.init("JdlaY1LThC-wKEczu");
    })();
    
    let currentSection = 'dashboard';
    
    // Verifica autenticazione
    function checkAuth() {
      console.log('üîç Verifica autenticazione...');
  const adminSession = sessionStorage.getItem('aurooms_admin_session');
      if (!adminSession) {
        // Prova Netlify Identity se disponibile
        if (window.netlifyIdentity && window.netlifyIdentity.currentUser) {
          const user = window.netlifyIdentity.currentUser();
          const roles = (user && user.app_metadata && user.app_metadata.roles) || [];
          if (roles.includes('admin')) {
            const sess = { username: user.email||'admin', loginTime: new Date().toISOString(), identity:true };
            sessionStorage.setItem('aurooms_admin_session', JSON.stringify(sess));
    // Dopo aver creato la sessione locale, ricarica per proseguire
    window.location.replace('admin-dashboard.html');
          } else {
            console.log('‚ùå Nessuna sessione');
            window.location.replace('admin-login.html');
            return false;
          }
        } else {
          console.log('‚ùå Nessuna sessione');
          window.location.replace('admin-login.html');
          return false;
        }
      }
      
      try {
        const session = JSON.parse(adminSession);
        const loginTime = new Date(session.loginTime);
        const now = new Date();
        const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
        
  if (hoursSinceLogin > 24) {
          console.log('‚ùå Sessione scaduta');
          sessionStorage.removeItem('aurooms_admin_session');
          window.location.replace('admin-login.html');
          return false;
        }
        
        console.log('‚úÖ Autenticazione ok');
        document.getElementById('admin-username').textContent = session.username;
        
        document.getElementById('auth-loading').style.display = 'none';
        document.getElementById('admin-body').style.display = 'block';
        
        return true;
      } catch (error) {
  console.log('‚ùå Errore sessione:', error);
  sessionStorage.removeItem('aurooms_admin_session');
        window.location.replace('admin-login.html');
        return false;
      }
    }
    
    // Logout
  function logout() {
      if (confirm('Sei sicuro di voler effettuare il logout?')) {
        sessionStorage.removeItem('aurooms_admin_session');
    try { if (window.netlifyIdentity) netlifyIdentity.logout(); } catch {}
        window.location.href = 'admin-login.html';
      }
    }
    
    // Mostra sezione
    function showSection(sectionName) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      document.querySelectorAll('.sidebar-menu a').forEach(link => {
        link.classList.remove('active');
      });
      
      document.getElementById(`section-${sectionName}`).classList.add('active');
      document.getElementById(`menu-${sectionName}`).classList.add('active');
      
      const titles = {
        dashboard: { title: 'üìä Dashboard', subtitle: 'Panoramica generale del sistema' },
        transfers: { title: 'üè¶ Bonifici', subtitle: 'Conferma pagamenti tramite bonifico' },
        settings: { title: '‚öôÔ∏è Impostazioni', subtitle: 'Configurazione sistema' }
      };
      
      document.getElementById('page-title').textContent = titles[sectionName].title;
      document.getElementById('page-subtitle').textContent = titles[sectionName].subtitle;
      
      currentSection = sectionName;
      loadSectionData(sectionName);
    }
    
    // Carica dati sezione
  function loadSectionData(sectionName) {
      switch(sectionName) {
        case 'dashboard':
          loadDashboardData();
          break;
        case 'transfers':
          loadTransfersData();
          break;
        case 'settings':
      loadBankDetails();
      setTimeout(loadPricingSettings, 0);
          break;
      }
    }
    
    // Carica dati dashboard con statistiche complete
    function loadDashboardData() {
      const pendingBookings = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
      const confirmedBookings = JSON.parse(localStorage.getItem('aurooms_confirmed_bookings') || '[]');
      
      // Statistiche base
      const totalBookings = pendingBookings.length + confirmedBookings.length;
      const totalRevenue = [...pendingBookings, ...confirmedBookings].reduce((sum, booking) => sum + (booking.totalPrice || 0), 0);
      
      // Ricavi mese corrente
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      const monthlyRevenue = [...pendingBookings, ...confirmedBookings].filter(booking => {
        const bookingDate = new Date(booking.bookingDate || booking.confirmationDate);
        return bookingDate.getMonth() === currentMonth && bookingDate.getFullYear() === currentYear;
      }).reduce((sum, booking) => sum + (booking.totalPrice || 0), 0);
      
      // Camere prenotate (uniche)
      const uniqueRooms = new Set([...pendingBookings, ...confirmedBookings].map(b => b.roomName));
      const roomsBooked = uniqueRooms.size;
      
      // Valore medio prenotazione
      const avgBookingValue = totalBookings > 0 ? Math.round(totalRevenue / totalBookings) : 0;
      
      // Tasso di conversione (simulato)
      const conversionRate = totalBookings > 0 ? Math.min(95, 75 + Math.round(totalBookings / 10)) : 0;
      
      // Aggiorna UI
      document.getElementById('total-bookings').textContent = totalBookings;
      document.getElementById('monthly-revenue').textContent = `‚Ç¨${monthlyRevenue}`;
      document.getElementById('pending-transfers').textContent = pendingBookings.length;
      document.getElementById('rooms-booked').textContent = roomsBooked;
      document.getElementById('total-revenue').textContent = `‚Ç¨${totalRevenue}`;
      document.getElementById('avg-booking-value').textContent = `‚Ç¨${avgBookingValue}`;
      document.getElementById('conversion-rate').textContent = `${conversionRate}%`;

      // Attivit√† recente
      const recentActivity = [
        ...pendingBookings.map(b => ({
          type: 'pending',
          message: `Nuovo bonifico richiesto - ${b.bookingReference}`,
          time: new Date(b.bookingDate).toLocaleString('it-IT'),
          email: b.customerEmail
        })),
        ...confirmedBookings.map(b => ({
          type: 'confirmed',
          message: `Prenotazione confermata - ${b.bookingReference}`,
          time: new Date(b.confirmationDate).toLocaleString('it-IT'),
          email: b.customerEmail
        }))
      ].sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 5);
      
      const activityHtml = recentActivity.length ? recentActivity.map(activity => `
        <div style="padding: 1rem; border-left: 4px solid ${activity.type === 'pending' ? '#ffc107' : '#28a745'}; margin-bottom: 1rem; background: #f8f9fa;">
          <div style="font-weight: 600;">${activity.message}</div>
          <div style="font-size: 0.9rem; color: #4a5568; margin-top: 0.25rem;">
            ${activity.email} ‚Ä¢ ${activity.time}
          </div>
        </div>
      `).join('') : '<p style="color: #4a5568; text-align: center;">Nessuna attivit√† recente</p>';
      
      document.getElementById('recent-activity').innerHTML = activityHtml;
    }
    
    // Carica dati bonifici
    function loadTransfersData() {
      const pendingBookings = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
      const pendingAmount = pendingBookings.reduce((sum, booking) => sum + (booking.totalPrice || 0), 0);
      
      document.getElementById('pending-amount').textContent = `‚Ç¨${pendingAmount} in attesa`;
      
      const transfersHtml = pendingBookings.length ? pendingBookings.map(booking => `
        <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: #fff;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div style="font-size: 1.1rem; font-weight: bold; color: #007bff;">${booking.bookingReference}</div>
            <div style="background: #fff3cd; color: #856404; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">In Attesa</div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div><strong>Cliente:</strong><br>${booking.customerEmail}</div>
            <div><strong>Camera:</strong><br>${booking.roomName}</div>
            <div><strong>Date:</strong><br>${new Date(booking.checkin).toLocaleDateString('it-IT')} - ${new Date(booking.checkout).toLocaleDateString('it-IT')}</div>
            <div><strong>Importo:</strong><br><span style="font-size: 1.2rem; color: #007bff; font-weight: bold;">‚Ç¨${booking.totalPrice}</span></div>
          </div>
          
          <div style="display: flex; gap: 1rem;">
            <button onclick="confirmBankTransfer('${booking.bookingReference}')" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
              ‚úÖ Conferma Bonifico Ricevuto
            </button>
            <button onclick="copyBankingDetails('${booking.bookingReference}')" style="background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
              üìã Copia Dettagli
            </button>
          </div>
        </div>
      `).join('') : '<div style="text-align: center; padding: 3rem; color: #4a5568;">üéâ Nessun bonifico in attesa</div>';
      
      document.getElementById('transfers-content').innerHTML = transfersHtml;
    }
    
    // Conferma bonifico
    function confirmBankTransfer(bookingReference) {
      if (!confirm(`Confermare il bonifico per la prenotazione ${bookingReference}?`)) {
        return;
      }
      
      let pendingBookings = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
      const bookingIndex = pendingBookings.findIndex(b => b.bookingReference === bookingReference);
      
      if (bookingIndex === -1) {
        alert('‚ùå Prenotazione non trovata');
        return;
      }
      
      const booking = pendingBookings[bookingIndex];
      
      // Invia email di conferma pagamento
      const templateParams = {
        to_name: booking.customerEmail.split('@')[0],
        to_email: booking.customerEmail,
        customer_name: booking.customerEmail.split('@')[0],
        room_name: booking.roomName,
        checkin_date: new Date(booking.checkin).toLocaleDateString('it-IT'),
        checkout_date: new Date(booking.checkout).toLocaleDateString('it-IT'),
        nights: booking.nights,
        guests: booking.guests,
        total_amount: booking.totalPrice,
        payment_method: 'Bonifico Bancario',
        booking_reference: booking.bookingReference,
        logo_url: window.location.origin + '/attached_assets/logo_aurooms.jpg',
        company_name: 'AUROOMS Guest House',
        from_name: 'AUROOMS Guest House',
        reply_to: 'info@aurooms.it'
      };
      
      emailjs.send('service_oiuox5y', 'payment_confirmation', templateParams)
        .then(function(response) {
          console.log('‚úÖ Conferma bonifico inviata!', response.status);
          
          // Rimuovi dalla lista pending
          pendingBookings.splice(bookingIndex, 1);
          localStorage.setItem('aurooms_pending_bookings', JSON.stringify(pendingBookings));
          
          // Aggiungi alla lista confermati
          let confirmedBookings = JSON.parse(localStorage.getItem('aurooms_confirmed_bookings') || '[]');
          confirmedBookings.push({
            ...booking,
            status: 'confirmed',
            confirmationDate: new Date().toISOString()
          });
          localStorage.setItem('aurooms_confirmed_bookings', JSON.stringify(confirmedBookings));
          
          alert(`‚úÖ Bonifico confermato per prenotazione ${bookingReference}\nüìß Email di conferma inviata a ${booking.customerEmail}`);
          
          loadSectionData(currentSection);
          
        }, function(error) {
          console.error('‚ùå Errore invio conferma bonifico:', error);
          alert(`‚ùå Errore nell'invio della conferma per ${bookingReference}`);
        });
    }
    
    // Copia dettagli bonifico
    function copyBankingDetails(bookingReference) {
      const pendingBookings = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
      const booking = pendingBookings.find(b => b.bookingReference === bookingReference);
      
      if (!booking) {
        alert('‚ùå Prenotazione non trovata');
        return;
      }
      
      const bankingDetails = `Dettagli Bonifico - ${bookingReference}

üè¶ IBAN: ${localStorage.getItem('bank_iban') || 'IT60 X054 2811 1010 0000 0123 456'}
üè¶ BIC: ${localStorage.getItem('bank_bic') || 'BPMOIT22XXX'}
üè¶ Intestatario: ${localStorage.getItem('bank_holder') || 'AUROOMS Guest House'}
üí∞ Importo: ‚Ç¨${booking.totalPrice}
üìù Causale: Prenotazione ${booking.roomName}
üî¢ Riferimento: ${bookingReference}

Cliente: ${booking.customerEmail}
Camera: ${booking.roomName}
Date: ${new Date(booking.checkin).toLocaleDateString('it-IT')} ‚Üí ${new Date(booking.checkout).toLocaleDateString('it-IT')}`;
      
      navigator.clipboard.writeText(bankingDetails).then(() => {
        alert('üìã Dettagli bonifico copiati negli appunti!');
      }).catch(() => {
        alert('üìã Dettagli bonifico pronti per essere copiati:\n\n' + bankingDetails);
      });
    }
    
    // Salva coordinate bancarie
    function saveBankDetails() {
      const iban = document.getElementById('bank-iban').value;
      const bic = document.getElementById('bank-bic').value;
      const holder = document.getElementById('bank-holder').value;
      
      if (!iban || !bic || !holder) {
        alert('‚ùå Compila tutti i campi');
        return;
      }
      
      localStorage.setItem('bank_iban', iban);
      localStorage.setItem('bank_bic', bic);
      localStorage.setItem('bank_holder', holder);
      
      // Trigger evento per sincronizzazione
      window.dispatchEvent(new StorageEvent('storage', {
        key: 'bank_updated',
        newValue: JSON.stringify({ iban, bic, holder }),
        url: window.location.href
      }));
      
      alert('‚úÖ Coordinate bancarie salvate con successo!\n\nüîÑ Tutte le pagine del sito sono ora aggiornate con le nuove coordinate.');
    }
    
    // Carica coordinate bancarie salvate
    function loadBankDetails() {
      const savedIban = localStorage.getItem('bank_iban');
      const savedBic = localStorage.getItem('bank_bic');
      const savedHolder = localStorage.getItem('bank_holder');
      
      if (savedIban) document.getElementById('bank-iban').value = savedIban;
      if (savedBic) document.getElementById('bank-bic').value = savedBic;
      if (savedHolder) document.getElementById('bank-holder').value = savedHolder;
    }

    // ===================== PREZZI DINAMICI (ADMIN) =====================
    function getDefaultPricingSettings() {
      return {
        season: { lowMonths: [1,2,3,11,12], lowPercent: -20, highMonths: [6,7,8], highPercent: 25 },
        weekend: { days: [5,6], percent: 10 },
        longStay: { threshold: 5, percent: -10 },
        rounding: { mode: 'round' }
      };
    }

    function monthLabels() {
      return ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
    }

    function renderMonthCheckboxes(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';
      const labels = monthLabels();
      for (let i = 1; i <= 12; i++) {
        const lbl = labels[i-1];
        const id = `${containerId}-${i}`;
        const wrap = document.createElement('label');
        wrap.style.display = 'inline-flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '.35rem';
        wrap.style.border = '1px solid #e2e8f0';
        wrap.style.borderRadius = '6px';
        wrap.style.padding = '.25rem .5rem';
        wrap.innerHTML = `<input type="checkbox" id="${id}" data-month="${i}"><span>${lbl}</span>`;
        container.appendChild(wrap);
      }
    }

    function renderWeekendDays() {
      const container = document.getElementById('weekend-days');
      container.innerHTML = '';
      const days = [
        {v:0,l:'Dom'}, {v:1,l:'Lun'}, {v:2,l:'Mar'}, {v:3,l:'Mer'}, {v:4,l:'Gio'}, {v:5,l:'Ven'}, {v:6,l:'Sab'}
      ];
      days.forEach(d => {
        const id = `wd-${d.v}`;
        const wrap = document.createElement('label');
        wrap.style.display = 'inline-flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '.35rem';
        wrap.style.border = '1px solid #e2e8f0';
        wrap.style.borderRadius = '6px';
        wrap.style.padding = '.25rem .5rem';
        wrap.innerHTML = `<input type="checkbox" id="${id}" data-day="${d.v}"><span>${d.l}</span>`;
        container.appendChild(wrap);
      });
    }

    function loadPricingSettings() {
      // Build controls if not present
      renderMonthCheckboxes('high-months');
      renderMonthCheckboxes('low-months');
      renderWeekendDays();

      const saved = localStorage.getItem('aurooms_pricing_settings');
      const s = saved ? JSON.parse(saved) : getDefaultPricingSettings();

      // Months
      (s.season?.highMonths || []).forEach(m => {
        const el = document.querySelector(`#high-months [data-month="${m}"]`);
        if (el) el.checked = true;
      });
      (s.season?.lowMonths || []).forEach(m => {
        const el = document.querySelector(`#low-months [data-month="${m}"]`);
        if (el) el.checked = true;
      });
      // Percents
      document.getElementById('high-percent').value = s.season?.highPercent ?? 25;
      document.getElementById('low-percent').value = s.season?.lowPercent ?? -20;

      // Weekend
      (s.weekend?.days || [5,6]).forEach(d => {
        const el = document.querySelector(`#weekend-days [data-day="${d}"]`);
        if (el) el.checked = true;
      });
      document.getElementById('weekend-percent').value = s.weekend?.percent ?? 10;

      // Long stay
      document.getElementById('long-threshold').value = s.longStay?.threshold ?? 5;
      document.getElementById('long-percent').value = s.longStay?.percent ?? -10;

      // Rounding
      document.getElementById('rounding-mode').value = s.rounding?.mode || 'round';
    }

    function savePricingSettings() {
      const highMonths = Array.from(document.querySelectorAll('#high-months [data-month]:checked')).map(el => parseInt(el.getAttribute('data-month')));
      const lowMonths = Array.from(document.querySelectorAll('#low-months [data-month]:checked')).map(el => parseInt(el.getAttribute('data-month')));
      const highPercent = parseFloat(document.getElementById('high-percent').value || '0');
      const lowPercent = parseFloat(document.getElementById('low-percent').value || '0');
      const weekendDays = Array.from(document.querySelectorAll('#weekend-days [data-day]:checked')).map(el => parseInt(el.getAttribute('data-day')));
      const weekendPercent = parseFloat(document.getElementById('weekend-percent').value || '0');
      const threshold = parseInt(document.getElementById('long-threshold').value || '0');
      const longPercent = parseFloat(document.getElementById('long-percent').value || '0');
      const rounding = document.getElementById('rounding-mode').value || 'round';

      const settings = {
        season: { highMonths, highPercent, lowMonths, lowPercent },
        weekend: { days: weekendDays, percent: weekendPercent },
        longStay: { threshold, percent: longPercent },
        rounding: { mode: rounding }
      };

      localStorage.setItem('aurooms_pricing_settings', JSON.stringify(settings));

      alert('‚úÖ Impostazioni prezzi dinamici salvate');
    }

    function resetPricingSettings() {
      localStorage.removeItem('aurooms_pricing_settings');
      loadPricingSettings();
      alert('‚ôªÔ∏è Impostazioni ripristinate ai valori predefiniti');
    }

    function previewPricing() {
      const base = 100;
      const today = new Date();
      const in3 = new Date(today);
      in3.setDate(in3.getDate() + 3);
      const s = JSON.parse(localStorage.getItem('aurooms_pricing_settings') || JSON.stringify(getDefaultPricingSettings()));
      // Calcolo semplice qui replicando formula (senza dipendere da script.js)
      function calc(basePrice, start, end) {
        const totalNights = Math.max(1, Math.ceil((end - start) / 86400000));
        let subtotal = 0;
        const d = new Date(start);
        for (let i = 0; i < totalNights; i++) {
          const m = d.getMonth() + 1;
          const dow = d.getDay();
          let pct = 0;
          if ((s.season.highMonths||[]).includes(m)) pct += (s.season.highPercent||0);
          else if ((s.season.lowMonths||[]).includes(m)) pct += (s.season.lowPercent||0);
          if ((s.weekend.days||[]).includes(dow)) pct += (s.weekend.percent||0);
          subtotal += basePrice * (1 + pct/100);
          d.setDate(d.getDate() + 1);
        }
        if (s.longStay.threshold && totalNights >= s.longStay.threshold) {
          subtotal *= (1 + (s.longStay.percent||0)/100);
        }
        const mode = s.rounding?.mode || 'round';
        if (mode === 'floor') return Math.floor(subtotal);
        if (mode === 'ceil') return Math.ceil(subtotal);
        return Math.round(subtotal);
      }

      const total = calc(base, today, in3);
      document.getElementById('pricing-preview').textContent = `Anteprima: base ‚Ç¨${base} per 3 notti ‚Üí totale ‚Ç¨${total}`;
    }
    
    // Inizializzazione
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Inizializzazione dashboard...');
      try { if (window.netlifyIdentity) netlifyIdentity.init(); } catch {}
      
      if (checkAuth()) {
        loadDashboardData();
        loadBankDetails(); // Carica le coordinate bancarie salvate
      }
      
      // Controllo sessione periodico leggero
      setInterval(function() {
        const adminSession = sessionStorage.getItem('aurooms_admin_session');
        if (!adminSession) {
          console.log('üö® Sessione rimossa - Reindirizzamento');
          window.location.replace('admin-login.html');
        }
      }, 60000);
    });
  </script>
</body>
</html>
