<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestione Bonifici - AUROOMS</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="style.css">
  <!-- EmailJS per invio email reali -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
    }
    
    .booking-card {
      background: #2d3748;
      border: 1px solid #4a5568;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      color: #ffffff;
    }
    
    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .booking-reference {
      font-size: 1.2rem;
      font-weight: bold;
      color: #007bff;
    }
    
    .booking-status {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
    }
    
    .status-pending {
      background: #ffc107;
      color: #000;
    }
    
    .status-confirmed {
      background: #28a745;
      color: #fff;
    }
    
    .booking-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .detail-label {
      font-size: 0.9rem;
      color: #a0aec0;
    }
    
    .detail-value {
      font-weight: bold;
    }
    
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <nav class="container-fluid">
    <ul>
      <li>
        <a href="index.html" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
          <img src="./attached_assets/logo_aurooms.jpg" alt="AUROOMS Logo" style="height: 35px; width: auto; border-radius: 4px;">
          <strong>AUROOMS</strong>
        </a>
      </li>
    </ul>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="#" onclick="refreshData()">üîÑ Aggiorna</a></li>
    </ul>
  </nav>

  <main class="container">
    <div class="admin-container">
      <hgroup style="text-align: center; margin-bottom: 2rem;">
        <h1>üè¶ Gestione Bonifici Bancari</h1>
        <p>Monitora e conferma i pagamenti tramite bonifico</p>
      </hgroup>

      <!-- Statistiche -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div style="background: #2d3748; padding: 1.5rem; border-radius: 8px; text-align: center; color: #fff;">
          <h3 id="pending-count">0</h3>
          <p>Bonifici in Attesa</p>
        </div>
        <div style="background: #28a745; padding: 1.5rem; border-radius: 8px; text-align: center; color: #fff;">
          <h3 id="confirmed-count">0</h3>
          <p>Prenotazioni Confermate</p>
        </div>
        <div style="background: #007bff; padding: 1.5rem; border-radius: 8px; text-align: center; color: #fff;">
          <h3 id="total-amount">‚Ç¨0</h3>
          <p>Importo Totale in Attesa</p>
        </div>
      </div>

      <!-- Lista Bonifici in Attesa -->
      <section>
        <h2>üìã Bonifici in Attesa di Conferma</h2>
        <div id="pending-bookings">
          <!-- Popolato dinamicamente -->
        </div>
      </section>

      <!-- Lista Prenotazioni Confermate -->
      <section style="margin-top: 3rem;">
        <h2>‚úÖ Prenotazioni Confermate</h2>
        <div id="confirmed-bookings">
          <!-- Popolato dinamicamente -->
        </div>
      </section>
    </div>
  </main>

  <script>
    // Inizializza EmailJS
    (function(){
      emailjs.init("JdlaY1LThC-wKEczu");
    })();
    
    function loadBookings() {
      const pendingBookings = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
      const confirmedBookings = JSON.parse(localStorage.getItem('aurooms_confirmed_bookings') || '[]');
      
      // Aggiorna statistiche
      document.getElementById('pending-count').textContent = pendingBookings.length;
      document.getElementById('confirmed-count').textContent = confirmedBookings.length;
      
      const totalAmount = pendingBookings.reduce((sum, booking) => sum + (booking.totalPrice || 0), 0);
      document.getElementById('total-amount').textContent = `‚Ç¨${totalAmount}`;
      
      // Carica bonifici in attesa
      renderPendingBookings(pendingBookings);
      
      // Carica prenotazioni confermate
      renderConfirmedBookings(confirmedBookings);
    }
    
    function renderPendingBookings(bookings) {
      const container = document.getElementById('pending-bookings');
      
      if (bookings.length === 0) {
        container.innerHTML = '<div class="empty-state">üéâ Nessun bonifico in attesa</div>';
        return;
      }
      
      container.innerHTML = bookings.map(booking => `
        <div class="booking-card">
          <div class="booking-header">
            <div class="booking-reference">${booking.bookingReference}</div>
            <div class="booking-status status-pending">In Attesa</div>
          </div>
          
          <div class="booking-details">
            <div class="detail-item">
              <span class="detail-label">Cliente</span>
              <span class="detail-value">${booking.customerEmail}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Camera</span>
              <span class="detail-value">${booking.roomName}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Check-in</span>
              <span class="detail-value">${new Date(booking.checkin).toLocaleDateString('it-IT')}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Check-out</span>
              <span class="detail-value">${new Date(booking.checkout).toLocaleDateString('it-IT')}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Ospiti</span>
              <span class="detail-value">${booking.guests}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Importo</span>
              <span class="detail-value">‚Ç¨${booking.totalPrice}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Richiesto il</span>
              <span class="detail-value">${new Date(booking.bookingDate).toLocaleString('it-IT')}</span>
            </div>
          </div>
          
          <div class="action-buttons">
            <button onclick="confirmBankTransfer('${booking.bookingReference}')" class="primary">
              ‚úÖ Conferma Bonifico Ricevuto
            </button>
            <button onclick="copyBankingDetails('${booking.bookingReference}')" style="background: #6c757d;">
              üìã Copia Dettagli Bonifico
            </button>
          </div>
        </div>
      `).join('');
    }
    
    function renderConfirmedBookings(bookings) {
      const container = document.getElementById('confirmed-bookings');
      
      if (bookings.length === 0) {
        container.innerHTML = '<div class="empty-state">Nessuna prenotazione confermata ancora</div>';
        return;
      }
      
      container.innerHTML = bookings.slice(0, 10).map(booking => `
        <div class="booking-card">
          <div class="booking-header">
            <div class="booking-reference">${booking.bookingReference}</div>
            <div class="booking-status status-confirmed">Confermata</div>
          </div>
          
          <div class="booking-details">
            <div class="detail-item">
              <span class="detail-label">Cliente</span>
              <span class="detail-value">${booking.customerEmail}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Camera</span>
              <span class="detail-value">${booking.roomName}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Importo</span>
              <span class="detail-value">‚Ç¨${booking.totalPrice}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Confermata il</span>
              <span class="detail-value">${new Date(booking.confirmationDate).toLocaleString('it-IT')}</span>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function confirmBankTransfer(bookingReference) {
      if (!confirm(`Confermare il bonifico per la prenotazione ${bookingReference}?`)) {
        return;
      }
      
      let pendingBookings = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
      const bookingIndex = pendingBookings.findIndex(b => b.bookingReference === bookingReference);
      
      if (bookingIndex === -1) {
        alert('‚ùå Prenotazione non trovata');
        return;
      }
      
      const booking = pendingBookings[bookingIndex];
      
      // Invia email di conferma pagamento
      const templateParams = {
        to_name: booking.customerEmail.split('@')[0],
        to_email: booking.customerEmail,
        customer_name: booking.customerEmail.split('@')[0],
        room_name: booking.roomName,
        checkin_date: new Date(booking.checkin).toLocaleDateString('it-IT'),
        checkout_date: new Date(booking.checkout).toLocaleDateString('it-IT'),
        nights: booking.nights,
        guests: booking.guests,
        total_amount: booking.totalPrice,
        payment_method: 'Bonifico Bancario',
        booking_reference: booking.bookingReference,
        logo_url: window.location.origin + '/attached_assets/logo_aurooms.jpg',
        company_name: 'AUROOMS Guest House',
        from_name: 'AUROOMS Guest House',
        reply_to: 'info@aurooms.it'
      };
      
      emailjs.send('service_oiuox5y', 'payment_confirmation', templateParams)
        .then(function(response) {
          console.log('‚úÖ Conferma bonifico inviata!', response.status);
          
          // Rimuovi dalla lista pending
          pendingBookings.splice(bookingIndex, 1);
          localStorage.setItem('aurooms_pending_bookings', JSON.stringify(pendingBookings));
          
          // Aggiungi alla lista confermati
          let confirmedBookings = JSON.parse(localStorage.getItem('aurooms_confirmed_bookings') || '[]');
          confirmedBookings.push({
            ...booking,
            status: 'confirmed',
            confirmationDate: new Date().toISOString()
          });
          localStorage.setItem('aurooms_confirmed_bookings', JSON.stringify(confirmedBookings));
          
          alert(`‚úÖ Bonifico confermato per prenotazione ${bookingReference}\nüìß Email di conferma inviata a ${booking.customerEmail}`);
          
          // Ricarica la pagina
          loadBookings();
          
        }, function(error) {
          console.error('‚ùå Errore invio conferma bonifico:', error);
          alert(`‚ùå Errore nell'invio della conferma per ${bookingReference}`);
        });
    }
    
    function copyBankingDetails(bookingReference) {
      const pendingBookings = JSON.parse(localStorage.getItem('aurooms_pending_bookings') || '[]');
      const booking = pendingBookings.find(b => b.bookingReference === bookingReference);
      
      if (!booking) {
        alert('‚ùå Prenotazione non trovata');
        return;
      }
      
      // Ottieni coordinate bancarie aggiornate dal localStorage
      const bankIban = localStorage.getItem('bank_iban') || "IT60 X054 2811 1010 0000 0123 456";
      const bankBic = localStorage.getItem('bank_bic') || "BPMOIT22XXX";
      const bankHolder = localStorage.getItem('bank_holder') || "AUROOMS Guest House";
      
      const bankingDetails = `Dettagli Bonifico - ${bookingReference}

üè¶ IBAN: ${bankIban}
üè¶ BIC: ${bankBic}
üè¶ Intestatario: ${bankHolder}
üí∞ Importo: ‚Ç¨${booking.totalPrice}
üìù Causale: Prenotazione ${booking.roomName}
üî¢ Riferimento: ${bookingReference}

Cliente: ${booking.customerEmail}
Camera: ${booking.roomName}
Date: ${new Date(booking.checkin).toLocaleDateString('it-IT')} ‚Üí ${new Date(booking.checkout).toLocaleDateString('it-IT')}`;
      
      navigator.clipboard.writeText(bankingDetails).then(() => {
        alert('üìã Dettagli bonifico copiati negli appunti!');
      }).catch(() => {
        // Fallback per browser che non supportano clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = bankingDetails;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('üìã Dettagli bonifico copiati negli appunti!');
      });
    }
    
    function refreshData() {
      loadBookings();
      alert('üîÑ Dati aggiornati');
    }
    
    // Carica i dati al caricamento della pagina
    document.addEventListener('DOMContentLoaded', loadBookings);
  </script>
</body>
</html>
