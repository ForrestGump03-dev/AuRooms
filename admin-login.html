<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login Admin - AUROOMS</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    .login-container {
      max-width: 400px;
      margin: 5rem auto;
      padding: 2rem;
    }
    
    .login-card {
      background: #2d3748;
      border: 1px solid #4a5568;
      border-radius: 12px;
      padding: 2rem;
      color: #ffffff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .admin-logo {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .admin-logo h1 {
      color: #007bff;
      margin-bottom: 0.5rem;
    }
    
    .admin-logo p {
      color: #a0aec0;
      font-size: 0.9rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #e2e8f0;
      font-weight: 500;
    }
    
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #4a5568;
      border-radius: 6px;
      background: #1a202c;
      color: #ffffff;
      font-size: 1rem;
    }
    
    .form-group input:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .login-button {
      width: 100%;
      padding: 0.875rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .login-button:hover {
      background: #0056b3;
    }
    
    .login-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    .error-message {
      background: #dc3545;
      color: white;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      display: none;
    }
    
    .security-note {
      text-align: center;
      margin-top: 2rem;
      color: #6c757d;
      font-size: 0.85rem;
    }
    
    .back-link {
      text-align: center;
      margin-top: 1rem;
    }
    
    .back-link a {
      color: #007bff;
      text-decoration: none;
      font-size: 0.9rem;
    }
    
    .back-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <main class="container">
    <div class="login-container">
      <div class="login-card">
        <div class="admin-logo">
          <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 1rem;">
            <img src="./attached_assets/logo_aurooms.jpg" alt="AUROOMS Logo" style="height: 40px; width: auto; border-radius: 4px;">
            <h1 style="margin: 0;">üîê AUROOMS</h1>
          </div>
          <p>Area Amministrazione</p>
        </div>
        
        <div id="error-message" class="error-message" style="display:none;">
          Accesso consentito solo agli admin.
        </div>

        <div style="margin: .75rem 0; text-align:center; color:#a0aec0;">oppure</div>
        <button id="netlify-login-btn" class="login-button" style="background:#0ea5e9;">
          üîê Accedi con Netlify Identity
        </button>
        
        <div class="security-note">
          üîí Accesso riservato al personale autorizzato
        </div>
        
        <div class="back-link">
          <a href="index.html">‚Üê Torna al sito</a>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ---- Netlify Identity integrazione ----
    function hasAdminRole(user){
      try {
        const roles = (user && user.app_metadata && user.app_metadata.roles) || [];
        return roles.includes('admin');
      } catch { return false; }
    }
    function setAdminSessionFromIdentity(user){
      if(!user) return;
      const adminSession = {
        username: user.email || (user.user_metadata && user.user_metadata.full_name) || 'admin',
        loginTime: new Date().toISOString(),
        identity: true
      };
      sessionStorage.setItem('aurooms_admin_session', JSON.stringify(adminSession));
    }
  document.addEventListener('DOMContentLoaded', function(){
      if (window.netlifyIdentity) {
        function handleTokens(){
          try {
            var h = (window.location.hash||'');
            if (/invite_token|confirmation_token|recovery_token|access_token/.test(h)) {
              netlifyIdentity.open();
            }
            else {
              // se non ci sono token e non c'√® sessione, apri direttamente il login per velocizzare
              var hasSession = !!sessionStorage.getItem('aurooms_admin_session');
              if (!hasSession) {
                setTimeout(function(){ try { netlifyIdentity.open('login'); } catch(_){} }, 100);
              }
            }
          } catch {}
        }
        netlifyIdentity.on('init', (user)=>{
          if (user && hasAdminRole(user)) {
            setAdminSessionFromIdentity(user);
            window.location.href = 'admin-dashboard.html';
          }
          handleTokens();
        });
  netlifyIdentity.on('login', (user)=>{
          if (hasAdminRole(user)) {
            setAdminSessionFromIdentity(user);
            window.location.href = 'admin-dashboard.html';
          } else {
            const msg = document.getElementById('error-message');
            if (msg) { msg.style.display = 'block'; }
            netlifyIdentity.logout();
          }
        });
        netlifyIdentity.on('logout', ()=>{
          sessionStorage.removeItem('aurooms_admin_session');
        });
        netlifyIdentity.init();
        const nb = document.getElementById('netlify-login-btn');
        if (nb) nb.addEventListener('click', ()=> netlifyIdentity.open('login'));
      }
    });
  // Se gi√† loggato via Identity, reindirizza al dashboard
    document.addEventListener('DOMContentLoaded', function() {
      const adminSession = sessionStorage.getItem('aurooms_admin_session');
      if (adminSession) {
        try {
          const session = JSON.parse(adminSession);
          const loginTime = new Date(session.loginTime);
          const now = new Date();
      const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
      if (hoursSinceLogin < 24) {
            window.location.href = 'admin-dashboard.html';
          } else {
            sessionStorage.removeItem('aurooms_admin_session');
          }
        } catch {
          sessionStorage.removeItem('aurooms_admin_session');
        }
      }
    });
  </script>
</body>
</html>
