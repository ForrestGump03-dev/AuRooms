<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Login - AUROOMS Guest House</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav class="container-fluid">
    <ul>
      <li>
        <a href="index.html" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
          <img src="./attached_assets/logo_aurooms.jpg" alt="AUROOMS Logo" style="height: 35px; width: auto; border-radius: 4px;">
          <strong>AUROOMS</strong>
        </a>
      </li>
    </ul>
    <ul>
      <li><a href="index.html#booking" role="button" data-lang="it">Prenota</a></li>
      <li><a href="index.html#booking" role="button" class="hidden" data-lang="en">Book Now</a></li>
      <li class="lang-toggle">
        <img src="https://flagcdn.com/w40/it.png" class="flag" onclick="switchLang('it')" alt="IT">
        <img src="https://flagcdn.com/w40/gb.png" class="flag" onclick="switchLang('en')" alt="EN">
      </li>
    </ul>
  </nav>

  <main class="container">
    <section style="max-width: 500px; margin: 2rem auto; padding: 2rem;">
      <div class="auth-container">
        <!-- Login Form -->
        <div id="login-form" class="auth-form">
          <hgroup style="text-align: center; margin-bottom: 2rem;">
            <h2 data-lang="it">Accedi al tuo Account</h2>
            <h2 class="hidden" data-lang="en">Login to Your Account</h2>
            <p data-lang="it">Inserisci le tue credenziali per continuare</p>
            <p class="hidden" data-lang="en">Enter your credentials to continue</p>
          </hgroup>

          <!-- Google Login Button -->
          <div style="margin-bottom: 1.5rem;">
            <button type="button" onclick="startGoogleLogin()" 
                    style="width: 100%; padding: 12px; background: #4285f4; color: white; border: none; border-radius: 6px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer;">
              <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                <path fill="#4285F4" d="m18 9.2c0-.6-.1-1.1-.2-1.6h-8.4v3.2h4.8c-.2 1.1-.8 2-1.7 2.6v2.1h2.7c1.6-1.5 2.5-3.7 2.5-6.3z"/>
                <path fill="#34A853" d="m9.4 18c2.3 0 4.2-.8 5.6-2.1l-2.7-2.1c-.8.5-1.8.8-2.9.8-2.2 0-4.1-1.5-4.8-3.5h-2.8v2.2c1.4 2.8 4.3 4.7 7.6 4.7z"/>
                <path fill="#FBBC05" d="m4.6 10.9c-.2-.5-.2-1.1-.2-1.7s.1-1.2.2-1.7v-2.2h-2.8c-.5 1.1-.8 2.3-.8 3.6s.3 2.5.8 3.6l2.8-2.1z"/>
                <path fill="#EA4335" d="m9.4 3.6c1.3 0 2.4.4 3.3 1.3l2.5-2.5c-1.5-1.4-3.4-2.3-5.8-2.3-3.3 0-6.2 1.9-7.6 4.7l2.8 2.2c.7-2.1 2.6-3.6 4.8-3.6z"/>
              </svg>
              <span data-lang="it">Accedi con Google</span>
              <span class="hidden" data-lang="en">Sign in with Google</span>
            </button>
          </div>

          <div style="text-align: center; margin: 1rem 0; color: #6c757d;">- oppure -</div>

          <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group">
              <label for="loginEmail" data-lang="it">Email</label>
              <label for="loginEmail" class="hidden" data-lang="en">Email</label>
              <input type="email" id="loginEmail" name="email" required 
                     placeholder="esempio@email.com" />
            </div>

            <div class="form-group">
              <label for="loginPassword" data-lang="it">Password</label>
              <label for="loginPassword" class="hidden" data-lang="en">Password</label>
              <input type="password" id="loginPassword" name="password" required 
                     placeholder="••••••••" />
            </div>

            <div id="login-error" class="error-message" style="display: none;"></div>

            <div style="text-align: center; margin: 1rem 0;">
              <a href="#" onclick="showForgotPassword()" style="color: #007bff; text-decoration: underline; font-size: 0.9rem;">
                <span data-lang="it">Hai dimenticato la password?</span>
                <span class="hidden" data-lang="en">Forgot password?</span>
              </a>
            </div>

            <button type="submit" class="primary" style="width: 100%; margin-top: 1rem;">
              <span data-lang="it">Accedi</span>
              <span class="hidden" data-lang="en">Login</span>
            </button>
          </form>

          <div style="text-align: center; margin-top: 1.5rem;">
            <p data-lang="it">Non hai un account? 
              <a href="#" onclick="showRegisterForm()" style="text-decoration: underline;">Registrati</a>
            </p>
            <p class="hidden" data-lang="en">Don't have an account? 
              <a href="#" onclick="showRegisterForm()" style="text-decoration: underline;">Register</a>
            </p>
          </div>
        </div>

        <!-- Register Form -->
        <div id="register-form" class="auth-form" style="display: none;">
          <hgroup style="text-align: center; margin-bottom: 2rem;">
            <h2 data-lang="it">Crea un Nuovo Account</h2>
            <h2 class="hidden" data-lang="en">Create a New Account</h2>
            <p data-lang="it">Registrati per prenotare le tue camere</p>
            <p class="hidden" data-lang="en">Register to book your rooms</p>
          </hgroup>

          <!-- Google Registration Button -->
          <div style="margin-bottom: 1.5rem;">
            <button type="button" onclick="startGoogleLogin()" 
                    style="width: 100%; padding: 12px; background: #4285f4; color: white; border: none; border-radius: 6px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer;">
              <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                <path fill="#4285F4" d="m18 9.2c0-.6-.1-1.1-.2-1.6h-8.4v3.2h4.8c-.2 1.1-.8 2-1.7 2.6v2.1h2.7c1.6-1.5 2.5-3.7 2.5-6.3z"/>
                <path fill="#34A853" d="m9.4 18c2.3 0 4.2-.8 5.6-2.1l-2.7-2.1c-.8.5-1.8.8-2.9.8-2.2 0-4.1-1.5-4.8-3.5h-2.8v2.2c1.4 2.8 4.3 4.7 7.6 4.7z"/>
                <path fill="#FBBC05" d="m4.6 10.9c-.2-.5-.2-1.1-.2-1.7s.1-1.2.2-1.7v-2.2h-2.8c-.5 1.1-.8 2.3-.8 3.6s.3 2.5.8 3.6l2.8-2.1z"/>
                <path fill="#EA4335" d="m9.4 3.6c1.3 0 2.4.4 3.3 1.3l2.5-2.5c-1.5-1.4-3.4-2.3-5.8-2.3-3.3 0-6.2 1.9-7.6 4.7l2.8 2.2c.7-2.1 2.6-3.6 4.8-3.6z"/>
              </svg>
              <span data-lang="it">Registrati con Google</span>
              <span class="hidden" data-lang="en">Sign up with Google</span>
            </button>
          </div>

          <div style="text-align: center; margin: 1rem 0; color: #6c757d;">- oppure -</div>

          <form id="registerForm" onsubmit="handleRegister(event)">
            <div class="form-group">
              <label for="registerFirstName" data-lang="it">Nome</label>
              <label for="registerFirstName" class="hidden" data-lang="en">First Name</label>
              <input type="text" id="registerFirstName" name="firstName" required 
                     placeholder="Mario" />
            </div>

            <div class="form-group">
              <label for="registerLastName" data-lang="it">Cognome</label>
              <label for="registerLastName" class="hidden" data-lang="en">Last Name</label>
              <input type="text" id="registerLastName" name="lastName" required 
                     placeholder="Rossi" />
            </div>

            <div class="form-group">
              <label for="registerEmail" data-lang="it">Email</label>
              <label for="registerEmail" class="hidden" data-lang="en">Email</label>
              <input type="email" id="registerEmail" name="email" required 
                     placeholder="esempio@email.com" />
            </div>

            <div class="form-group">
              <label for="registerPhone" data-lang="it">Telefono</label>
              <label for="registerPhone" class="hidden" data-lang="en">Phone</label>
              <input type="tel" id="registerPhone" name="phone" required 
                     placeholder="+39 123 456 7890" />
            </div>

            <div class="form-group">
              <label for="registerPassword" data-lang="it">Password</label>
              <label for="registerPassword" class="hidden" data-lang="en">Password</label>
              <input type="password" id="registerPassword" name="password" required 
                     placeholder="••••••••" minlength="6" />
            </div>

            <div class="form-group">
              <label for="confirmPassword" data-lang="it">Conferma Password</label>
              <label for="confirmPassword" class="hidden" data-lang="en">Confirm Password</label>
              <input type="password" id="confirmPassword" name="confirmPassword" required 
                     placeholder="••••••••" minlength="6" />
            </div>

            <div id="register-error" class="error-message" style="display: none;"></div>

            <button type="submit" class="primary" style="width: 100%; margin-top: 1rem;">
              <span data-lang="it">Registrati</span>
              <span class="hidden" data-lang="en">Register</span>
            </button>
          </form>

          <div style="text-align: center; margin-top: 1.5rem;">
            <p data-lang="it">Hai già un account? 
              <a href="#" onclick="showLoginForm()" style="text-decoration: underline;">Accedi</a>
            </p>
            <p class="hidden" data-lang="en">Already have an account? 
              <a href="#" onclick="showLoginForm()" style="text-decoration: underline;">Login</a>
            </p>
          </div>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgot-password-form" class="auth-form" style="display: none;">
          <hgroup style="text-align: center; margin-bottom: 2rem;">
            <h2 data-lang="it">Recupera Password</h2>
            <h2 class="hidden" data-lang="en">Reset Password</h2>
            <p data-lang="it">Inserisci la tua email per ricevere il link di reset</p>
            <p class="hidden" data-lang="en">Enter your email to receive reset link</p>
          </hgroup>

          <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
            <div class="form-group">
              <label for="forgotEmail" data-lang="it">Email</label>
              <label for="forgotEmail" class="hidden" data-lang="en">Email</label>
              <input type="email" id="forgotEmail" name="email" required 
                     placeholder="esempio@email.com" />
            </div>

            <div id="forgot-error" class="error-message" style="display: none;"></div>
            <div id="forgot-success" class="success-message" style="display: none;"></div>

            <button type="submit" class="primary" style="width: 100%; margin-top: 1rem;">
              <span data-lang="it">Invia Link Reset</span>
              <span class="hidden" data-lang="en">Send Reset Link</span>
            </button>
          </form>

          <div style="text-align: center; margin-top: 1.5rem;">
            <p>
              <a href="#" onclick="showLoginForm()" style="text-decoration: underline;">
                <span data-lang="it">← Torna al Login</span>
                <span class="hidden" data-lang="en">← Back to Login</span>
              </a>
            </p>
          </div>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="success-message" style="display: none;">
          <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
            <h3 data-lang="it">Accesso Effettuato!</h3>
            <h3 class="hidden" data-lang="en">Login Successful!</h3>
            <p data-lang="it">Reindirizzamento in corso...</p>
            <p class="hidden" data-lang="en">Redirecting...</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer with contact info -->
  <footer class="container" style="margin-top: 2rem; padding: 1rem; text-align: center; border-top: 1px solid var(--border-color);">
    <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
      <a href="https://wa.me/393758843175" target="_blank" style="color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
        <img src="./attached_assets/icons8-whatsapp-30.png" alt="WhatsApp" style="width: 18px; height: 18px;">
        <span>WhatsApp</span>
      </a>
      <a href="tel:+393758843175" style="color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 18px;">📞</span>
        <span>+39 375 884 3175</span>
      </a>
      <a href="mailto:info@aurooms.it" style="color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 18px;">📧</span>
        <span>info@aurooms.it</span>
      </a>
    </div>
  </footer>

  <!-- WhatsApp Floating Button -->
  <a class="whatsapp-button" href="https://wa.me/393758843175" target="_blank" title="Contattaci su WhatsApp">
    <img src="./attached_assets/icons8-whatsapp-30.png" alt="WhatsApp" style="width: 32px; height: 32px;">
  </a>

  <script src="script.js"></script>
  <script>
    // Configuration
    const API_BASE_URL = 'https://aurooms-backend-cre8.onrender.com/api';

    // Google OAuth Functions
    function startGoogleLogin() {
      console.log('🔍 Avvio login Google OAuth...');
      
      // Mostra loading
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<span>🔄 Connessione...</span>';
      button.disabled = true;
      
      // Chiama il backend per ottenere l'URL di autorizzazione Google
      fetch(`${getBackendUrl()}/auth/google/start`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('✅ URL OAuth ricevuto:', data.auth_url);
          
          // Reindirizza a Google OAuth
          window.location.href = data.auth_url;
        })
        .catch(error => {
          console.error('❌ Errore Google OAuth:', error);
          
          // Ripristina il pulsante
          button.innerHTML = originalText;
          button.disabled = false;
          
          // Mostra errore
          const errorDiv = document.getElementById('login-error');
          errorDiv.textContent = getCurrentLanguage() === 'it' ? 
            'Errore di connessione. Riprova.' : 'Connection error. Please try again.';
          errorDiv.style.display = 'block';
        });
    }

    function getBackendUrl() {
      // URL del tuo backend su Render
      return 'https://aurooms-backend-cre8.onrender.com/api';
    }

    // Google Login Handler (legacy - da rimuovere)
    function handleGoogleLogin(response) {
      const credential = response.credential;
      
      // Decodifica il JWT token per ottenere le informazioni utente
      const userInfo = JSON.parse(atob(credential.split('.')[1]));
      
      // Crea utente fake per compatibilità (in produzione userai l'API backend)
      const googleUser = {
        id: userInfo.sub,
        email: userInfo.email,
        firstName: userInfo.given_name,
        lastName: userInfo.family_name,
        name: userInfo.name,
        phone: '',
        profilePicture: userInfo.picture,
        provider: 'google'
      };
      
      // Salva utente e continua il flusso esistente
      localStorage.setItem('aurooms_current_user', JSON.stringify(googleUser));
      showSuccessMessage();
      
      setTimeout(() => {
        const pendingBooking = sessionStorage.getItem('pending_booking');
        if (pendingBooking) {
          location.replace('pagamento.html');
        } else {
          location.replace('dashboard.html');
        }
      }, 2000);
    }

    // Forgot Password Handler
    function handleForgotPassword(event) {
      event.preventDefault();
      
      const email = document.getElementById('forgotEmail').value;
      const errorDiv = document.getElementById('forgot-error');
      const successDiv = document.getElementById('forgot-success');
      
      // Reset messages
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      if (!email) {
        errorDiv.textContent = getCurrentLanguage() === 'it' ? 
          'Inserisci la tua email' : 'Please enter your email';
        errorDiv.style.display = 'block';
        return;
      }
      
      // Simula invio email di reset
      successDiv.textContent = getCurrentLanguage() === 'it' ? 
        'Se l\'email esiste, riceverai le istruzioni per il reset' : 
        'If email exists, you will receive reset instructions';
      successDiv.style.display = 'block';
      
      // In futuro qui chiameresti l'API backend
      // fetch(`${API_BASE_URL}/auth/forgot-password`, { method: 'POST', ... })
    }

    function showForgotPassword() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('forgot-password-form').style.display = 'block';
      clearErrorMessages();
    }

    function clearErrorMessages() {
      const errorDivs = document.querySelectorAll('.error-message');
      errorDivs.forEach(div => div.style.display = 'none');
    }

    // Enhanced Authentication Functions
    function handleLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('login-error');
      
      // Simulated authentication
      const users = JSON.parse(localStorage.getItem('aurooms_users') || '[]');
      const user = users.find(u => u.email === email && u.password === password);
      
      if (user) {
        // Login successful
        localStorage.setItem('aurooms_current_user', JSON.stringify(user));
        showSuccessMessage();
        
        // Clean redirect logic with explicit path checking
        setTimeout(() => {
          const pendingBooking = sessionStorage.getItem('pending_booking');
          console.log('Login redirect - pendingBooking:', pendingBooking);
          
          // Clear any potential bad cache
          if (location.href.includes('rooms.html')) {
            console.warn('Detected old rooms.html reference, correcting...');
          }
          
          if (pendingBooking) {
            console.log('Redirecting to pagamento.html');
            // Force redirect with replace to avoid history issues
            location.replace('pagamento.html');
          } else {
            console.log('Redirecting to dashboard.html');
            // Force redirect with replace to avoid history issues
            location.replace('dashboard.html');
          }
        }, 2000);
      } else {
        errorDiv.textContent = getCurrentLanguage() === 'it' ? 
          'Email o password non corretti' : 'Invalid email or password';
        errorDiv.style.display = 'block';
      }
    }
    
    function handleRegister(event) {
      event.preventDefault();
      
      const firstName = document.getElementById('registerFirstName').value;
      const lastName = document.getElementById('registerLastName').value;
      const email = document.getElementById('registerEmail').value;
      const phone = document.getElementById('registerPhone').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('register-error');
      
      // Validation
      if (password !== confirmPassword) {
        errorDiv.textContent = getCurrentLanguage() === 'it' ? 
          'Le password non coincidono' : 'Passwords do not match';
        errorDiv.style.display = 'block';
        return;
      }
      
      // Check if user already exists
      const users = JSON.parse(localStorage.getItem('aurooms_users') || '[]');
      if (users.find(u => u.email === email)) {
        errorDiv.textContent = getCurrentLanguage() === 'it' ? 
          'Email già registrata' : 'Email already registered';
        errorDiv.style.display = 'block';
        return;
      }
      
      // Create new user with separate first and last name
      const newUser = { 
        firstName, 
        lastName, 
        name: `${firstName} ${lastName}`, // Keep full name for compatibility
        email, 
        phone, 
        password 
      };
      users.push(newUser);
      localStorage.setItem('aurooms_users', JSON.stringify(users));
      localStorage.setItem('aurooms_current_user', JSON.stringify(newUser));
      
      showSuccessMessage();
      
      // Clean redirect logic with explicit path checking
      setTimeout(() => {
        const pendingBooking = sessionStorage.getItem('pending_booking');
        console.log('Registration redirect - pendingBooking:', pendingBooking);
        
        // Clear any potential bad cache
        if (location.href.includes('rooms.html')) {
          console.warn('Detected old rooms.html reference, correcting...');
        }
        
        if (pendingBooking) {
          console.log('Redirecting to pagamento.html');
          // Force redirect with replace to avoid history issues
          location.replace('pagamento.html');
        } else {
          console.log('Redirecting to dashboard.html');
          // Force redirect with replace to avoid history issues  
          location.replace('dashboard.html');
        }
      }, 2000);
    }
    
    function showLoginForm() {
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('forgot-password-form').style.display = 'none';
      clearErrorMessages();
    }
    
    function showRegisterForm() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
      document.getElementById('forgot-password-form').style.display = 'none';
      clearErrorMessages();
    }
    
    function showSuccessMessage() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('success-message').style.display = 'block';
    }
    
    function getCurrentLanguage() {
      return localStorage.getItem('aurooms_language') || 'it';
    }
    
    function clearOldReferences() {
      // Clear any cached redirect references to rooms.html
      console.log('Clearing any old references...');
      
      // Check and clean sessionStorage
      const sessionKeys = Object.keys(sessionStorage);
      sessionKeys.forEach(key => {
        const value = sessionStorage.getItem(key);
        if (value && value.includes && value.includes('rooms.html')) {
          console.log(`Removing old reference in sessionStorage key: ${key}`);
          sessionStorage.removeItem(key);
        }
      });
      
      // Check and clean localStorage for any room references (excluding our data)
      const localKeys = Object.keys(localStorage);
      localKeys.forEach(key => {
        if (!key.startsWith('aurooms_')) {
          const value = localStorage.getItem(key);
          if (value && value.includes && value.includes('rooms.html')) {
            console.log(`Removing old reference in localStorage key: ${key}`);
            localStorage.removeItem(key);
          }
        }
      });
    }
    
    function switchLang(lang) {
      localStorage.setItem('aurooms_language', lang);
      document.querySelectorAll('[data-lang]').forEach(el => {
        if (el.getAttribute('data-lang') === lang) {
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      });
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Clear any old room references that might be cached
      clearOldReferences();
      
      const currentLang = getCurrentLanguage();
      switchLang(currentLang);
      
      // Check if user is already logged in
      const currentUser = localStorage.getItem('aurooms_current_user');
      console.log('Page load - currentUser:', currentUser);
      if (currentUser) {
        // User already logged in, redirect to booking flow
        const pendingBooking = sessionStorage.getItem('pending_booking');
        console.log('Page load - pendingBooking:', pendingBooking);
        
        // Clear any potential bad cache
        if (location.href.includes('rooms.html')) {
          console.warn('Detected old rooms.html reference, correcting...');
        }
        
        if (pendingBooking) {
          console.log('Page load redirecting to pagamento.html');
          location.replace('pagamento.html');
        } else {
          console.log('Page load redirecting to dashboard.html');
          location.replace('dashboard.html');
        }
      }
    });
  </script>
</body>
</html>
