<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Login - AUROOMS Guest House</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav class="container-fluid">
    <ul>
      <li>
        <a href="index.html" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
          <img src="./attached_assets/logo_aurooms.jpg" alt="AUROOMS Logo" style="height: 35px; width: auto; border-radius: 4px;">
          <strong>AUROOMS</strong>
        </a>
      </li>
    </ul>
    <ul>
      <li><a href="index.html#booking" role="button" data-lang="it">Prenota</a></li>
      <li><a href="index.html#booking" role="button" class="hidden" data-lang="en">Book Now</a></li>
      <li class="lang-toggle">
        <img src="https://flagcdn.com/w40/it.png" class="flag" onclick="switchLang('it')" alt="IT">
        <img src="https://flagcdn.com/w40/gb.png" class="flag" onclick="switchLang('en')" alt="EN">
      </li>
    </ul>
  </nav>

  <main class="container">
    <section style="max-width: 500px; margin: 2rem auto; padding: 2rem;">
      <div class="auth-container">
        <!-- Login Form -->
        <div id="login-form" class="auth-form">
          <hgroup style="text-align: center; margin-bottom: 2rem;">
            <h2 data-lang="it">Accedi al tuo Account</h2>
            <h2 class="hidden" data-lang="en">Login to Your Account</h2>
            <p data-lang="it">Inserisci le tue credenziali per continuare</p>
            <p class="hidden" data-lang="en">Enter your credentials to continue</p>
          </hgroup>

          <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group">
              <label for="loginEmail" data-lang="it">Email</label>
              <label for="loginEmail" class="hidden" data-lang="en">Email</label>
              <input type="email" id="loginEmail" name="email" required 
                     placeholder="esempio@email.com" />
            </div>

            <div class="form-group">
              <label for="loginPassword" data-lang="it">Password</label>
              <label for="loginPassword" class="hidden" data-lang="en">Password</label>
              <input type="password" id="loginPassword" name="password" required 
                     placeholder="••••••••" />
            </div>

            <div id="login-error" class="error-message" style="display: none;"></div>

            <button type="submit" class="primary" style="width: 100%; margin-top: 1rem;">
              <span data-lang="it">Accedi</span>
              <span class="hidden" data-lang="en">Login</span>
            </button>
          </form>

          <div style="text-align: center; margin-top: 1.5rem;">
            <p data-lang="it">Non hai un account? 
              <a href="#" onclick="showRegisterForm()" style="text-decoration: underline;">Registrati</a>
            </p>
            <p class="hidden" data-lang="en">Don't have an account? 
              <a href="#" onclick="showRegisterForm()" style="text-decoration: underline;">Register</a>
            </p>
          </div>
        </div>

        <!-- Register Form -->
        <div id="register-form" class="auth-form" style="display: none;">
          <hgroup style="text-align: center; margin-bottom: 2rem;">
            <h2 data-lang="it">Crea un Nuovo Account</h2>
            <h2 class="hidden" data-lang="en">Create a New Account</h2>
            <p data-lang="it">Registrati per prenotare le tue camere</p>
            <p class="hidden" data-lang="en">Register to book your rooms</p>
          </hgroup>

          <form id="registerForm" onsubmit="handleRegister(event)">
            <div class="form-group">
              <label for="registerFirstName" data-lang="it">Nome</label>
              <label for="registerFirstName" class="hidden" data-lang="en">First Name</label>
              <input type="text" id="registerFirstName" name="firstName" required 
                     placeholder="Mario" />
            </div>

            <div class="form-group">
              <label for="registerLastName" data-lang="it">Cognome</label>
              <label for="registerLastName" class="hidden" data-lang="en">Last Name</label>
              <input type="text" id="registerLastName" name="lastName" required 
                     placeholder="Rossi" />
            </div>

            <div class="form-group">
              <label for="registerEmail" data-lang="it">Email</label>
              <label for="registerEmail" class="hidden" data-lang="en">Email</label>
              <input type="email" id="registerEmail" name="email" required 
                     placeholder="esempio@email.com" />
            </div>

            <div class="form-group">
              <label for="registerPhone" data-lang="it">Telefono</label>
              <label for="registerPhone" class="hidden" data-lang="en">Phone</label>
              <input type="tel" id="registerPhone" name="phone" required 
                     placeholder="+39 123 456 7890" />
            </div>

            <div class="form-group">
              <label for="registerPassword" data-lang="it">Password</label>
              <label for="registerPassword" class="hidden" data-lang="en">Password</label>
              <input type="password" id="registerPassword" name="password" required 
                     placeholder="••••••••" minlength="6" />
            </div>

            <div class="form-group">
              <label for="confirmPassword" data-lang="it">Conferma Password</label>
              <label for="confirmPassword" class="hidden" data-lang="en">Confirm Password</label>
              <input type="password" id="confirmPassword" name="confirmPassword" required 
                     placeholder="••••••••" minlength="6" />
            </div>

            <div id="register-error" class="error-message" style="display: none;"></div>

            <button type="submit" class="primary" style="width: 100%; margin-top: 1rem;">
              <span data-lang="it">Registrati</span>
              <span class="hidden" data-lang="en">Register</span>
            </button>
          </form>

          <div style="text-align: center; margin-top: 1.5rem;">
            <p data-lang="it">Hai già un account? 
              <a href="#" onclick="showLoginForm()" style="text-decoration: underline;">Accedi</a>
            </p>
            <p class="hidden" data-lang="en">Already have an account? 
              <a href="#" onclick="showLoginForm()" style="text-decoration: underline;">Login</a>
            </p>
          </div>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="success-message" style="display: none;">
          <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
            <h3 data-lang="it">Accesso Effettuato!</h3>
            <h3 class="hidden" data-lang="en">Login Successful!</h3>
            <p data-lang="it">Reindirizzamento in corso...</p>
            <p class="hidden" data-lang="en">Redirecting...</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- WhatsApp Floating Button -->
  <a class="whatsapp-button" href="https://wa.me/393758843175" target="_blank" title="Contattaci su WhatsApp">
    <img src="./attached_assets/whatsapplogo_1753691477533.png" alt="WhatsApp" style="width: 32px; height: 32px;">
  </a>

  <script src="script.js"></script>
  <script>
    // Authentication Functions
    function handleLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('login-error');
      
      // Simulated authentication
      const users = JSON.parse(localStorage.getItem('aurooms_users') || '[]');
      const user = users.find(u => u.email === email && u.password === password);
      
      if (user) {
        // Login successful
        localStorage.setItem('aurooms_current_user', JSON.stringify(user));
        showSuccessMessage();
        
        // Clean redirect logic with explicit path checking
        setTimeout(() => {
          const pendingBooking = sessionStorage.getItem('pending_booking');
          console.log('Login redirect - pendingBooking:', pendingBooking);
          
          // Clear any potential bad cache
          if (location.href.includes('rooms.html')) {
            console.warn('Detected old rooms.html reference, correcting...');
          }
          
          if (pendingBooking) {
            console.log('Redirecting to pagamento.html');
            // Force redirect with replace to avoid history issues
            location.replace('pagamento.html');
          } else {
            console.log('Redirecting to dashboard.html');
            // Force redirect with replace to avoid history issues
            location.replace('dashboard.html');
          }
        }, 2000);
      } else {
        errorDiv.textContent = getCurrentLanguage() === 'it' ? 
          'Email o password non corretti' : 'Invalid email or password';
        errorDiv.style.display = 'block';
      }
    }
    
    function handleRegister(event) {
      event.preventDefault();
      
      const firstName = document.getElementById('registerFirstName').value;
      const lastName = document.getElementById('registerLastName').value;
      const email = document.getElementById('registerEmail').value;
      const phone = document.getElementById('registerPhone').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('register-error');
      
      // Validation
      if (password !== confirmPassword) {
        errorDiv.textContent = getCurrentLanguage() === 'it' ? 
          'Le password non coincidono' : 'Passwords do not match';
        errorDiv.style.display = 'block';
        return;
      }
      
      // Check if user already exists
      const users = JSON.parse(localStorage.getItem('aurooms_users') || '[]');
      if (users.find(u => u.email === email)) {
        errorDiv.textContent = getCurrentLanguage() === 'it' ? 
          'Email già registrata' : 'Email already registered';
        errorDiv.style.display = 'block';
        return;
      }
      
      // Create new user with separate first and last name
      const newUser = { 
        firstName, 
        lastName, 
        name: `${firstName} ${lastName}`, // Keep full name for compatibility
        email, 
        phone, 
        password 
      };
      users.push(newUser);
      localStorage.setItem('aurooms_users', JSON.stringify(users));
      localStorage.setItem('aurooms_current_user', JSON.stringify(newUser));
      
      showSuccessMessage();
      
      // Clean redirect logic with explicit path checking
      setTimeout(() => {
        const pendingBooking = sessionStorage.getItem('pending_booking');
        console.log('Registration redirect - pendingBooking:', pendingBooking);
        
        // Clear any potential bad cache
        if (location.href.includes('rooms.html')) {
          console.warn('Detected old rooms.html reference, correcting...');
        }
        
        if (pendingBooking) {
          console.log('Redirecting to pagamento.html');
          // Force redirect with replace to avoid history issues
          location.replace('pagamento.html');
        } else {
          console.log('Redirecting to dashboard.html');
          // Force redirect with replace to avoid history issues  
          location.replace('dashboard.html');
        }
      }, 2000);
    }
    
    function showLoginForm() {
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('login-error').style.display = 'none';
      document.getElementById('register-error').style.display = 'none';
    }
    
    function showRegisterForm() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
      document.getElementById('login-error').style.display = 'none';
      document.getElementById('register-error').style.display = 'none';
    }
    
    function showSuccessMessage() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('success-message').style.display = 'block';
    }
    
    function getCurrentLanguage() {
      return localStorage.getItem('aurooms_language') || 'it';
    }
    
    function clearOldReferences() {
      // Clear any cached redirect references to rooms.html
      console.log('Clearing any old references...');
      
      // Check and clean sessionStorage
      const sessionKeys = Object.keys(sessionStorage);
      sessionKeys.forEach(key => {
        const value = sessionStorage.getItem(key);
        if (value && value.includes && value.includes('rooms.html')) {
          console.log(`Removing old reference in sessionStorage key: ${key}`);
          sessionStorage.removeItem(key);
        }
      });
      
      // Check and clean localStorage for any room references (excluding our data)
      const localKeys = Object.keys(localStorage);
      localKeys.forEach(key => {
        if (!key.startsWith('aurooms_')) {
          const value = localStorage.getItem(key);
          if (value && value.includes && value.includes('rooms.html')) {
            console.log(`Removing old reference in localStorage key: ${key}`);
            localStorage.removeItem(key);
          }
        }
      });
    }
    
    function switchLang(lang) {
      localStorage.setItem('aurooms_language', lang);
      document.querySelectorAll('[data-lang]').forEach(el => {
        if (el.getAttribute('data-lang') === lang) {
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      });
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Clear any old room references that might be cached
      clearOldReferences();
      
      const currentLang = getCurrentLanguage();
      switchLang(currentLang);
      
      // Check if user is already logged in
      const currentUser = localStorage.getItem('aurooms_current_user');
      console.log('Page load - currentUser:', currentUser);
      if (currentUser) {
        // User already logged in, redirect to booking flow
        const pendingBooking = sessionStorage.getItem('pending_booking');
        console.log('Page load - pendingBooking:', pendingBooking);
        
        // Clear any potential bad cache
        if (location.href.includes('rooms.html')) {
          console.warn('Detected old rooms.html reference, correcting...');
        }
        
        if (pendingBooking) {
          console.log('Page load redirecting to pagamento.html');
          location.replace('pagamento.html');
        } else {
          console.log('Page load redirecting to dashboard.html');
          location.replace('dashboard.html');
        }
      }
    });
  </script>
</body>
</html>
